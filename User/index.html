<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MinerApp — Real del Monte</title>
  <meta name="theme-color" content="#4f46e5">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Playball&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/user.css">

  <style>
    body { font-family: 'Poppins', sans-serif; background:#fff7ef; color:#2f1e16; }
    .fade-in { opacity: 0; transform: translateY(18px); transition: opacity .7s ease, transform .7s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    .glass { background: rgba(255,247,236,0.72); backdrop-filter: blur(6px); border:1px solid rgba(213,176,109,0.25); }
    .heritage-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:rgba(212,164,65,0.22); font-size:0.85rem; color:#7b4316; font-weight:600; }
    .tour-panel { display:flex; flex-direction:column; gap:1.5rem; }
    .tour-hints { padding:1.25rem; border-radius:1.25rem; background:linear-gradient(120deg,rgba(236,204,171,0.25),rgba(255,255,255,0.65)); border:1px solid rgba(199,161,120,0.45); box-shadow:0 15px 30px rgba(60,43,34,0.08) inset; }
    .tour-hints-title { font-size:0.95rem; font-weight:600; text-transform:uppercase; letter-spacing:0.15em; color:#b45309; margin-bottom:0.75rem; display:block; }
    .tour-hints-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:0.65rem; color:#5b4639; font-size:0.9rem; }
    .tour-hints-list li { display:flex; gap:0.65rem; align-items:flex-start; line-height:1.35; }
    .tour-hint-icon { width:1.65rem; height:1.65rem; border-radius:999px; background:#fff; border:1px solid rgba(180,83,9,0.35); display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem; color:#b45309; box-shadow:0 4px 8px rgba(60,43,34,0.08); flex-shrink:0; }
    .modal-reviews { margin-top:2rem; border-top:1px solid rgba(60,43,34,0.15); padding-top:1.5rem; }
    .modal-reviews h3 { font-size:1.1rem; font-weight:700; color:#3c2b22; margin-bottom:0.75rem; }
    .modal-review-list { display:flex; flex-direction:column; gap:0.8rem; max-height:220px; overflow:auto; padding-right:0.25rem; }
    .modal-review-item { border:1px solid rgba(60,43,34,0.12); border-radius:1rem; padding:0.85rem 1rem; background:#fff; }
    .modal-review-item small { display:block; color:#7b5a46; font-size:0.75rem; margin-top:0.25rem; }
    .review-rating { display:inline-flex; align-items:center; gap:0.35rem; font-weight:600; color:#b45309; background:rgba(180,83,9,0.08); border-radius:999px; padding:0.15rem 0.75rem; }
    .review-empty { text-align:center; padding:1.25rem; border-radius:1rem; background:rgba(255,255,255,0.65); border:1px dashed rgba(60,43,34,0.15); color:#7a5c4a; font-size:0.9rem; }
    .review-auth-alert { margin-top:0.75rem; font-size:0.85rem; color:#7b4316; background:rgba(180,83,9,0.08); border:1px dashed rgba(180,83,9,0.35); padding:0.8rem 1rem; border-radius:0.9rem; }
    .reviews-heading { display:flex; flex-direction:column; gap:0.4rem; margin-bottom:1.25rem; }
    .reviews-eyebrow { text-transform:uppercase; letter-spacing:0.3em; font-size:0.72rem; font-weight:700; color:#c06a1c; }
    .reviews-subheading { font-size:0.9rem; color:#7a5c4a; }
    .review-ghost-form { margin-top:1rem; padding:1rem 1.25rem; border-radius:1rem; border:1px dashed rgba(180,83,9,0.35); background:rgba(180,83,9,0.06); display:flex; flex-direction:column; gap:0.65rem; }
    .review-ghost-form strong { font-size:0.95rem; color:#4b2a13; }
    .lugares-eyebrow { display:inline-flex; align-items:center; gap:0.4rem; text-transform:uppercase; letter-spacing:0.28em; font-size:0.8rem; color:#c06a1c; font-weight:700; }
    .lugares-toolbar { background:rgba(255,255,255,0.92); border-radius:1.5rem; border:1px solid rgba(212,164,65,0.25); box-shadow:0 24px 50px rgba(60,43,34,0.08); padding:1.25rem; display:flex; flex-direction:column; gap:1rem; }
    .lugares-toolbar input,
    .lugares-toolbar select { border:1px solid rgba(99,71,54,0.2); border-radius:0.9rem; padding:0.9rem 1rem; background:#fffdf9; color:#3c2b22; font-weight:500; width:100%; }
    .lugares-toolbar input:focus,
    .lugares-toolbar select:focus { outline:none; box-shadow:0 0 0 3px rgba(212,164,65,0.25); }
    .lugares-toolbar label { display:block; margin-bottom:0.35rem; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.2em; color:#b08968; font-weight:600; }
    @media (min-width: 768px) {
      .lugares-toolbar { flex-direction:row; align-items:center; }
      .lugares-toolbar .toolbar-field { flex:1; }
      .lugares-toolbar .toolbar-select { width:260px; flex-shrink:0; }
    }
    @media (max-width: 640px) {
      .tour-hints { padding:1rem; }
      .tour-hints-list { font-size:0.85rem; }
      .modal-review-list { max-height:180px; }
    }
  </style>
</head>
<body class="bg-[#fff7ef] text-[#3c2b22] scroll-smooth" data-google-maps-key="">

  <div id="user-header-container"></div>

  <!-- Hero -->
  <section id="inicio" class="relative min-h-screen w-full flex flex-col items-center justify-center text-center px-4 py-16 sm:px-8 sm:py-20 overflow-hidden" style="background: radial-gradient(circle at top, rgba(212,164,65,0.25), transparent 55%), linear-gradient(135deg,#fff4e4 0%, #ffe4c1 60%, #fbe7d1 100%);">
    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
      <div class="absolute -top-10 -left-10 w-48 h-48 bg-white/30 rounded-full blur-3xl"></div>
      <div class="absolute bottom-5 right-5 w-56 h-56 bg-[#3a5a40]/10 rounded-full blur-3xl"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center gap-6">
      <span class="heritage-pill">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 13l9 8 9-8-9-8z"/></svg>
        Real del Monte • Pueblo Mágico
      </span>
      <h2 class="text-4xl sm:text-5xl md:text-6xl font-extrabold leading-tight text-[#4b2a13]">
        MinerApp
        <span class="block text-xl sm:text-2xl md:text-3xl font-semibold text-[#b45309]">La guía premium para explorar minas e historia.</span>
      </h2>
      <p class="text-base sm:text-lg md:text-xl text-[#5b4639] max-w-3xl">
        Paletas cálidas inspiradas en cantera, hierro y bosque minero para sumergirte en la esencia realista de Real del Monte.
      </p>

      <div class="flex flex-col sm:flex-row flex-wrap gap-4 mb-6 justify-center w-full sm:w-auto">
        <a href="/user/login" class="brand-cta px-6 py-3 rounded-2xl text-white text-sm uppercase tracking-wide">Explorar ahora</a>
        <a href="#lugares" class="glass px-6 py-3 rounded-2xl text-sm font-semibold text-[#3a2d25] hover:-translate-y-0.5 transition">Ver lugares destacados</a>
      </div>

      <div class="max-w-5xl w-full px-2 sm:px-0">
        <img src="https://www.viajabonito.mx/wp-content/uploads/2019/12/real-del-monte-pueblo-minero-100.jpg" alt="Mineral del Monte" class="rounded-3xl shadow-xl w-full object-cover border border-[#f0d4aa]">
      </div>
    </div>
  </section>

  <!-- Favoritos personalizados -->
  <section id="favoritos" class="py-16 px-4 sm:px-6 bg-[#fffaf4] border-t border-[#f6dcc4]">
    <div class="max-w-6xl mx-auto space-y-10">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-6 justify-between">
        <div>
          <p class="text-sm uppercase tracking-[0.3em] text-[#c06a1c]">Colección personal</p>
          <h3 class="text-3xl font-extrabold text-[#422515] mt-2">Tus tesoros favoritos de Real del Monte</h3>
          <p id="favoritesSubtitle" class="text-[#6b4a3b] mt-3 max-w-2xl">Inicia sesión en la experiencia Visitante para guardar y sincronizar tus rutas favoritas.</p>
        </div>
        <div>
          <a id="favoritesAction" href="/user/login" class="brand-cta inline-flex items-center gap-2 px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
            Inicia sesión
          </a>
        </div>
      </div>
      <div id="favoritesEmpty" class="favorites-empty text-center text-[#7a5c4a] bg-white/70 rounded-3xl border border-[#f1dac9] py-10 px-6">
        Inicia sesión para descubrir tu panel privado de favoritos en MinerApp Visitante.
      </div>
      <div id="favoritesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- Historia -->
  <section id="historia" class="py-16 sm:py-20 bg-white">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 md:px-10 space-y-16 sm:space-y-20">
      <div class="grid md:grid-cols-2 gap-8 sm:gap-10 items-center">
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">¿Sabías que?</h3>
          <p class="text-gray-700 leading-relaxed text-lg">El Conde de Regla hizo su fortuna con la plata de Real del Monte; hoy es un pueblo lleno de historia y tradiciones.</p>
        </div>
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://www.mexicoescultura.com/galerias/espacios/principal/real.jpg" alt="Calles de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-8 sm:gap-10 items-center">
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT9R-uUl4kbG_Y7tNroD5tU_GjoWu_oSS0Q_g&s" alt="Kiosko de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">La herencia británica</h3>
          <p class="text-gray-700 leading-relaxed text-lg mb-5">Gracias a los mineros de Cornualles, Real del Monte es la cuna del fútbol y del paste en México.</p>
          <a href="#lugares" class="inline-block brand-cta px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">Descubre lugares</a>
        </div>
      </div>
    </div>
  </section>

 <!-- Recorrido inmersivo -->
  <section id="tour" class="py-16 px-4 sm:px-6 bg-[#fffaf4] border-t border-[#f6dcc4]">
    <div class="max-w-6xl mx-auto space-y-10">
      <div class="tour-heading flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="tour-eyebrow">Recorrido inmersivo</p>
          <h3 class="text-3xl font-extrabold text-[#422515]">Activa Street View y planea tus visitas</h3>
          <p class="text-[#5b4639] max-w-2xl mt-3">Explora túneles y plazas antes de llegar. Añade tu clave de Google Maps para desbloquear el modo Street View interactivo.</p>
        </div>
        <div class="tour-status-chip" data-tour-status>
          <span class="dot" aria-hidden="true"></span>
          <span data-tour-status-label>Street View activo</span>
        </div>
      </div>

<div class="tour-shell">
        <div class="tour-media" data-tour-media>
          <iframe
            id="tourIframe"
            class="tour-iframe"
            title="Recorrido inmersivo por Real del Monte"
            allowfullscreen
            loading="lazy"
            src="https://www.google.com/maps/embed?pb=!4v1719525250327!6m8!1m7!1sCAoSLEFGMVFpcE5Yd29GWGhPWG5tN1EtQmtXUnpQMlM3Y1I0MngzN0dCMUpncVZh!2m2!1d20.1367594!2d-98.6723357!3f120!4f5!5f0.7820865974627469"
          ></iframe>
          <div id="streetViewCanvas" class="streetview-canvas" hidden aria-hidden="true"></div>
          <div class="tour-loader" data-tour-loading hidden>
            <span class="loader-dot" aria-hidden="true"></span>
            <p>Preparando Street View...</p>
          </div>
          <p class="tour-fallback" data-tour-fallback hidden>
            Agrega tu API key de Google Maps en <code>data-google-maps-key</code> para desbloquear Street View.
          </p>
        </div>
        <div class="tour-panel">
          <div class="tour-hints" aria-live="polite" aria-label="Instrucciones de Street View">
            <span class="tour-hints-title">Cómo usar Street View</span>
            <ul class="tour-hints-list">
              <li>
                <span class="tour-hint-icon">↻</span>
                Usa el mouse o tu dedo para girar y explorar cada rincón.
              </li>
              <li>
                <span class="tour-hint-icon">＋</span>
                Acerca o aleja con los controles + / - para ver más detalle.
              </li>
              <li>
                <span class="tour-hint-icon">⚠</span>
                Si no aparece Street View, puede que la zona aún no tenga cobertura.
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- Lugares -->
  <section id="lugares" class="py-16 px-4 sm:px-6" style="background: linear-gradient(180deg,#fff0de 0%, #fff7ef 60%, #fffdf8 100%); color:#3c2b22;">
    <div class="max-w-6xl mx-auto">
      <div class="text-center space-y-3 mb-10">
        <span class="lugares-eyebrow justify-center">Curaduría minera</span>
        <h3 class="text-3xl font-bold">Lugares destacados</h3>
        <p class="text-[#6b4a3b] max-w-3xl mx-auto">Descubre minas, miradores y rincones gastronómicos con el mismo lenguaje visual que usamos en la experiencia Visitante.</p>
      </div>

      <div class="lugares-toolbar glass mb-8">
        <div class="toolbar-field">
          <label for="searchInput">Explora Real del Monte</label>
          <input id="searchInput" type="search" placeholder="Buscar lugares, categorías o descripciones..." class="w-full bg-transparent focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="toolbar-select">
          <label for="categoryFilter">Filtrar por categoría</label>
          <select id="categoryFilter">
            <option value="">Todas las categorías</option>
          </select>
        </div>
      </div>

      <div id="lugaresGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards serán inyectadas aquí por JS -->
      </div>
    </div>
  </section>

      <!-- Modal detalle -->
      <div id="lugarModalBackdrop" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <button class="close-btn" id="modalCloseBtn" aria-label="Cerrar">✕</button>
          <div class="modal-body">
            <div class="modal-gallery gallery-stack-shell" id="modalGallery" data-native-carousel="true">
              <div id="modalGalleryStack" class="gallery-stack" aria-live="polite"></div>
          
            </div>
            <div class="modal-info">
              <p id="modalCategoria" class="chip modal-badge mb-2"></p>
              <h2 id="modalTitle" class="text-3xl font-extrabold mb-3"></h2>
              <p id="modalDesc" class="modal-desc mb-4"></p>
              <div id="modalMeta" class="modal-meta-grid"></div>
              <div id="modalTags" class="modal-tags"></div>
              <div class="modal-actions mt-6 flex gap-3 flex-wrap">
                <a id="modalMaps" class="brand-cta inline-block px-4 py-2 rounded-md" target="_blank" href="#">Ver en Maps</a>
                <button id="modalFav" type="button" class="fav-toggle" data-fav-id="">
                  <span class="fav-icon" aria-hidden="true">❤</span>
                  <span class="fav-label">Guardar</span>
                </button>
              </div>
              <div class="modal-reviews" id="publicReviews">
                <div class="reviews-heading">
                  <span class="reviews-eyebrow">Reseñas verificadas</span>
                  <h3>Opiniones de la comunidad</h3>
                  <p class="reviews-subheading">Historias auténticas de exploradores que ya vivieron Real del Monte.</p>
                </div>
                <div id="publicReviewsLoader" class="review-empty">Cargando reseñas...</div>
                <div id="publicReviewsList" class="modal-review-list"></div>
                <p id="publicReviewsEmpty" class="review-empty" hidden>Sé la primera persona en compartir una reseña.</p>
                <p class="review-auth-alert">¿Quieres dejar tu reseña? <a href="/user/login" class="underline font-semibold">Inicia sesión</a> para acceder a la experiencia Visitante completa.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

  <div id="user-footer-container"></div>

  <script src="/js/alerts.js"></script>
  <script src="/js/user.js"></script>
  <script>
    const appState = {
      currentUser: null,
      favoriteIds: new Set(),
      lugaresCache: [],
      lugarIndex: {},
      reviewsByLugar: {}
    };

    const filtersState = { bound: false };
    const authRedirectDelay = 1400;
    const searchControl = { timer: null, controller: null, warned: false, categoriesLoaded: false };
    const fallbackLugares = [
      { _id: '1', nombre: 'Mina Acosta', descripcion: 'Visitas guiadas por las antiguas minas.', images: [] , categoria: 'Museo' },
      { _id: '2', nombre: 'Museo del Sitio', descripcion: 'Conoce la historia minera.', images: [], categoria: 'Museo' },
      { _id: '3', nombre: 'Pastes', descripcion: 'Prueba el paste tradicional.', images: [], categoria: 'Gastronomía' }
    ];
    const FALLBACK_MODAL_IMAGE = 'https://via.placeholder.com/800x600?text=Sin+Imagen';
    const modalGalleryState = { images: [FALLBACK_MODAL_IMAGE], index: 0, title: 'Lugar destacado' };
    let modalKeyboardBound = false;
    const immersiveTourConfig = {
      iframeSrc: 'https://www.google.com/maps/embed?pb=!4v1719525250327!6m8!1m7!1sCAoSLEFGMVFpcE5Yd29GWGhPWG5tN1EtQmtXUnpQMlM3Y1I0MngzN0dCMUpncVZh!2m2!1d20.1367594!2d-98.6723357!3f120!4f5!5f0.7820865974627469',
      stops: [
        {
          id: 'mina-acosta',
          title: 'Mina Acosta',
          description: 'Ingresa a los túneles con maquinaria restaurada.',
          badge: 'Entrada principal',
          position: { lat: 20.13676, lng: -98.67233 },
          pov: { heading: 125, pitch: -5, zoom: 1 }
        },
        {
          id: 'plaza-principal',
          title: 'Plaza Juárez',
          description: 'Colores coloniales y la vida diaria del centro.',
          badge: 'Centro histórico',
          position: { lat: 20.13532, lng: -98.67205 },
          pov: { heading: 200, pitch: 0, zoom: 1 }
        },
        {
          id: 'museo-sitio',
          title: 'Museo del Sitio',
          description: 'Exposiciones que narran la bonanza minera.',
          badge: 'Museo',
          position: { lat: 20.13781, lng: -98.67382 },
          pov: { heading: 75, pitch: -2, zoom: 1 }
        }
      ]
    };
    const streetViewState = {
      sdkPromise: null,
      panorama: null,
      mode: 'iframe',
      activeStop: 0,
      loading: false
    };

    function notify(type, config) {
      if (window.alertCenter && typeof window.alertCenter[type] === 'function') {
        return window.alertCenter[type](config);
      }
      const msg = typeof config === 'string' ? config : (config && config.message) || 'Ocurrió un evento';
      return alert(msg);
    }

    function safeQuery(selector) { return document.querySelector(selector); }

    function formatDate(value) {
      if (!value) return '';
      try {
        return new Date(value).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (_) {
        return value;
      }
    }

    function getLugarIdentifier(lugar) {
      if (!lugar) return '';
      return String(lugar._id || lugar.id || lugar.nombre || '');
    }

    function getGoogleMapsKey() {
      const body = document.body;
      if (!body || !body.dataset) return '';
      return (body.dataset.googleMapsKey || '').trim();
    }

    function ensureGoogleMapsSdk(key) {
      if (window.google && window.google.maps) {
        return Promise.resolve(window.google.maps);
      }
      if (!key) return Promise.reject(new Error('missing-key'));
      if (!streetViewState.sdkPromise) {
        streetViewState.sdkPromise = new Promise((resolve, reject) => {
          const existingScript = document.getElementById('google-maps-sdk');
          if (existingScript && existingScript.getAttribute('data-loaded')) {
            return resolve(window.google.maps);
          }
          const script = existingScript || document.createElement('script');
          script.id = 'google-maps-sdk';
          script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&v=quarterly`;
          script.async = true;
          script.defer = true;
          script.onload = () => {
            script.setAttribute('data-loaded', 'true');
            resolve(window.google.maps);
          };
          script.onerror = () => reject(new Error('sdk-load-error'));
          if (!existingScript) document.head.appendChild(script);
        });
      }
      return streetViewState.sdkPromise;
    }

    function updateTourStatus(mode) {
      const chip = document.querySelector('[data-tour-status]');
      const label = document.querySelector('[data-tour-status-label]');
      if (!chip || !label) return;
      const messages = {
        iframe: 'Modo mapa interactivo',
        streetview: 'Street View activo',
        loading: 'Preparando Street View'
      };
      label.textContent = messages[mode] || messages.iframe;
      chip.setAttribute('data-mode', mode);
    }

    function toggleTourButtons(mode, { loading = false } = {}) {
      const streetBtn = document.querySelector('[data-tour-action="streetview"]');
      const iframeBtn = document.querySelector('[data-tour-action="iframe"]');
      if (mode === 'loading') {
        if (streetBtn) streetBtn.disabled = true;
        if (iframeBtn) iframeBtn.disabled = true;
        return;
      }
      if (streetBtn) streetBtn.disabled = loading || mode === 'streetview';
      if (iframeBtn) iframeBtn.disabled = loading || mode === 'iframe';
    }

    function showTourFallback(message) {
      const fallback = document.querySelector('[data-tour-fallback]');
      if (!fallback) return;
      if (message) {
        fallback.innerHTML = message;
      }
      fallback.hidden = false;
    }

    function hideTourFallback() {
      const fallback = document.querySelector('[data-tour-fallback]');
      if (fallback) fallback.hidden = true;
    }

    function setTourLoaderVisible(visible) {
      const loader = document.querySelector('[data-tour-loading]');
      if (loader) loader.hidden = !visible;
    }

    function renderTourStops() {
      const list = document.getElementById('tourStopsList');
      if (!list) return;
      list.innerHTML = immersiveTourConfig.stops.map((stop, idx) => `
        <li>
          <button type="button" class="tour-stop" data-stop-index="${idx}">
            <span class="tour-stop-index">${String(idx + 1).padStart(2, '0')}</span>
            <div class="tour-stop-copy">
              <p class="tour-stop-title">${stop.title}</p>
              <p class="tour-stop-desc">${stop.description}</p>
            </div>
            ${stop.badge ? `<span class="tour-stop-badge">${stop.badge}</span>` : ''}
          </button>
        </li>
      `).join('');
      highlightActiveStop(streetViewState.activeStop);
    }

    function highlightActiveStop(index) {
      document.querySelectorAll('[data-stop-index]').forEach(btn => {
        const isActive = Number(btn.dataset.stopIndex) === index;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-current', isActive ? 'true' : 'false');
      });
    }

    function setStreetViewPosition(index) {
      if (!streetViewState.panorama) return;
      const stop = immersiveTourConfig.stops[index];
      if (!stop) return;
      streetViewState.panorama.setPosition(stop.position);
      if (stop.pov) streetViewState.panorama.setPov(stop.pov);
      streetViewState.activeStop = index;
      highlightActiveStop(index);
    }

    function showIframeTour(fromError = false) {
      const iframe = document.getElementById('tourIframe');
      const canvas = document.getElementById('streetViewCanvas');
      if (!iframe || !canvas) return;
      setTourLoaderVisible(false);
      iframe.hidden = false;
      canvas.hidden = true;
      canvas.setAttribute('aria-hidden', 'true');
      streetViewState.mode = 'iframe';
      updateTourStatus('iframe');
      toggleTourButtons('iframe');
      if (fromError) {
        showTourFallback('No pudimos iniciar Street View. Revisa tu clave y vuelve a intentarlo.');
      } else {
        hideTourFallback();
      }
    }

    async function activateStreetView(index = 0) {
      const iframe = document.getElementById('tourIframe');
      const canvas = document.getElementById('streetViewCanvas');
      if (!iframe || !canvas) return;
      const key = getGoogleMapsKey();
      if (!key) {
        showTourFallback('Agrega tu API key de Google Maps en el atributo <code>data-google-maps-key</code> del <code>&lt;body&gt;</code>.');
        updateTourStatus('iframe');
        toggleTourButtons('iframe');
        return;
      }
      hideTourFallback();
      setTourLoaderVisible(true);
      updateTourStatus('loading');
      toggleTourButtons('loading');
      try {
        const maps = await ensureGoogleMapsSdk(key);
        iframe.hidden = true;
        canvas.hidden = false;
        canvas.setAttribute('aria-hidden', 'false');
        if (!streetViewState.panorama) {
          streetViewState.panorama = new maps.StreetViewPanorama(canvas, {
            addressControl: false,
            fullscreenControl: true,
            motionTracking: false,
            zoomControl: true,
            visible: true
          });
        }
        streetViewState.mode = 'streetview';
        setStreetViewPosition(index);
        updateTourStatus('streetview');
        toggleTourButtons('streetview');
      } catch (error) {
        console.error('No se pudo iniciar Street View', error);
        showIframeTour(true);
      } finally {
        setTourLoaderVisible(false);
      }
    }

    async function handleStopSelection(index) {
      streetViewState.activeStop = index;
      if (streetViewState.mode !== 'streetview') {
        await activateStreetView(index);
        return;
      }
      setStreetViewPosition(index);
    }

    function bindTourControls() {
      const streetBtn = document.querySelector('[data-tour-action="streetview"]');
      const iframeBtn = document.querySelector('[data-tour-action="iframe"]');
      if (streetBtn && !streetBtn.dataset.bound) {
        streetBtn.dataset.bound = 'true';
        streetBtn.addEventListener('click', () => activateStreetView(streetViewState.activeStop));
      }
      if (iframeBtn && !iframeBtn.dataset.bound) {
        iframeBtn.dataset.bound = 'true';
        iframeBtn.addEventListener('click', () => showIframeTour());
      }
      const stopsList = document.getElementById('tourStopsList');
      if (stopsList && !stopsList.dataset.bound) {
        stopsList.dataset.bound = 'true';
        stopsList.addEventListener('click', (event) => {
          const target = event.target.closest('[data-stop-index]');
          if (!target) return;
          const idx = Number(target.dataset.stopIndex);
          if (Number.isNaN(idx)) return;
          handleStopSelection(idx);
        });
      }
    }

    function initImmersiveTour() {
      const iframe = document.getElementById('tourIframe');
      const canvas = document.getElementById('streetViewCanvas');
      if (!iframe || !canvas) return;
      iframe.src = immersiveTourConfig.iframeSrc;
      streetViewState.activeStop = 0;
      renderTourStops();
      bindTourControls();
      showIframeTour();
    }

    async function showAuthPrompt() {
      if (window.alertCenter) {
        window.alertCenter.info({
          title: 'Inicia sesión para continuar',
          message: 'Necesitas una cuenta activa para guardar tus lugares favoritos.',
          actionLabel: 'Ir a iniciar sesión',
          onAction: () => { window.location.href = '/user/login'; },
          timeout: 6000
        });
        setTimeout(() => { window.location.href = '/user/login'; }, authRedirectDelay);
        return;
      }
      alert('Debes iniciar sesión antes de guardar favoritos.');
      window.location.href = '/user/login';
    }

    function renderFavoritesSection() {
      const empty = safeQuery('#favoritesEmpty');
      if (empty) {
        empty.textContent = 'Inicia sesión para descubrir tu panel privado de favoritos en MinerApp Visitante.';
        empty.style.display = '';
      }
      const grid = safeQuery('#favoritesGrid');
      if (grid) grid.innerHTML = '';
    }

    function getActiveFilters() {
      const search = safeQuery('#searchInput');
      const category = safeQuery('#categoryFilter');
      return {
        q: (search && search.value ? search.value.trim() : ''),
        categoria: (category && category.value) || ''
      };
    }

    function filterListLocally(list, filters) {
      if (!Array.isArray(list) || !list.length) return [];
      const q = (filters.q || '').toLowerCase();
      const categoria = filters.categoria || '';
      return list.filter(l => {
        const text = ((l.nombre || '') + ' ' + (l.descripcion || '') + ' ' + ((l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '')).toLowerCase();
        const matchesText = !q || text.includes(q);
        const catValue = (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '';
        const matchesCat = !categoria || catValue === categoria;
        return matchesText && matchesCat;
      });
    }

    function scheduleSearch() {
      if (searchControl.timer) clearTimeout(searchControl.timer);
      searchControl.timer = setTimeout(() => {
        loadLugares({ refreshCategories: false, fromSearch: true });
      }, 220);
    }

    function buildLugarImages(lugar) {
      const sources = [];
      if (Array.isArray(lugar.images)) sources.push(...lugar.images);
      if (Array.isArray(lugar.galeria)) sources.push(...lugar.galeria);
      ['image', 'imagen', 'fotoDestacada', 'cover', 'portada'].forEach(key => {
        if (typeof lugar[key] === 'string') sources.push(lugar[key]);
      });
      const clean = sources.map(src => typeof src === 'string' ? src.trim() : '').filter(Boolean);
      return clean.length ? Array.from(new Set(clean)) : [FALLBACK_MODAL_IMAGE];
    }

    function prepareModalGallery(lugar) {
      modalGalleryState.images = buildLugarImages(lugar);
      modalGalleryState.index = 0;
      modalGalleryState.title = lugar.nombre || 'Lugar destacado';
      updateModalCarousel();
    }

    function updateModalCarousel() {
      const stack = document.getElementById('modalGalleryStack');
      const hint = document.getElementById('modalGalleryHint');
      if (!stack) return;
      const total = modalGalleryState.images.length;
      stack.innerHTML = modalGalleryState.images.map((src, idx) => {
        const safeSrc = src || FALLBACK_MODAL_IMAGE;
        return `
          <figure class="gallery-frame">
            <img src="${safeSrc}" alt="${modalGalleryState.title} — imagen ${idx + 1}" loading="lazy" onerror="this.src='${FALLBACK_MODAL_IMAGE}'">
          </figure>
        `;
      }).join('');
      if (hint) {
        hint.hidden = total <= 1;
      }
    }

    function bindModalCarouselControls() {}

    function renderModalMeta(lugar) {
      const meta = document.getElementById('modalMeta');
      if (!meta) return;
      const entries = [
        { label: 'Ubicación', value: lugar.ubicacion || lugar.direccion || lugar.address || lugar.localizacion },
        { label: 'Horario', value: lugar.horario || lugar.horarios || lugar.horarioAtencion },
        { label: 'Contacto', value: lugar.telefono || lugar.contacto || lugar.whatsapp || lugar.email },
        { label: 'Costo', value: lugar.precio || lugar.costo || lugar.entrada }
      ].filter(item => item.value);
      if (!entries.length) {
        meta.innerHTML = '';
        meta.classList.add('is-hidden');
        return;
      }
      meta.classList.remove('is-hidden');
      meta.innerHTML = entries.map(item => `<div class="meta-card"><p class="meta-label">${item.label}</p><p class="meta-value">${item.value}</p></div>`).join('');
    }

    function renderModalTags(lugar) {
      const container = document.getElementById('modalTags');
      if (!container) return;
      let tags = [];
      if (Array.isArray(lugar.tags)) tags = tags.concat(lugar.tags);
      else if (typeof lugar.tags === 'string') tags = tags.concat(lugar.tags.split(',').map(tag => tag.trim()));
      if (Array.isArray(lugar.amenidades)) tags = tags.concat(lugar.amenidades);
      if (Array.isArray(lugar.servicios)) tags = tags.concat(lugar.servicios);
      ['tipo', 'especialidad', 'categoriaSecundaria'].forEach(key => {
        if (lugar[key]) tags.push(lugar[key]);
      });
      tags = tags.map(tag => (typeof tag === 'string' ? tag.trim() : tag)).filter(Boolean);
      if (!tags.length) {
        container.innerHTML = '';
        container.classList.add('is-hidden');
        return;
      }
      container.classList.remove('is-hidden');
      container.innerHTML = tags.slice(0, 8).map(tag => `<span class="tag-pill">${tag}</span>`).join('');
    }

    function createLugarCard(lugar) {
      const card = document.createElement('article');
      card.className = 'bg-white rounded-2xl p-0 shadow-sm hover:shadow-md transition fade-in lugar-card';
      const lugarId = String(lugar._id || lugar.id || lugar.nombre || Math.random());
      card.dataset.lugarId = lugarId;
      card.__lugarData = lugar;
      const imagen = (lugar.images && lugar.images.length) ? lugar.images[0] : 'https://via.placeholder.com/400x300?text=Sin+Imagen';
      const categoria = lugar.categoria ? (lugar.categoria.nombre || lugar.categoria) : (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
      const mapsLink = lugar.googleMapsLink || '#';

      card.innerHTML = `
        <div class="thumb-wrapper">
          <img src="${imagen}" alt="${lugar.nombre || 'Lugar'}" class="thumb" onerror="this.src='https://via.placeholder.com/400x300?text=Imagen+no+disponible'">
        </div>
        <div class="lugar-meta">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h4 class="lugar-title mb-1">${lugar.nombre || 'Sin nombre'}</h4>
              <p class="lugar-desc text-sm">${(lugar.descripcion || '').slice(0,140)}${(lugar.descripcion && lugar.descripcion.length>140)?'...':''}</p>
            </div>
            <button type="button" class="fav-toggle" data-fav-id="${lugarId}" aria-pressed="false">
              <span class="fav-icon" aria-hidden="true">❤</span>
              <span class="fav-label">Favorito</span>
            </button>
          </div>
          <div class="lugar-actions mt-3 flex items-center justify-between flex-wrap gap-3">
            <span class="chip">${categoria}</span>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-md text-sm border btn-detail">Ver detalles</button>
              <a href="${mapsLink}" target="_blank" class="px-3 py-2 rounded-md text-sm brand-cta">Maps</a>
            </div>
          </div>
        </div>
      `;

      return card;
    }

    function getLugarById(id) {
      if (!id) return null;
      return appState.lugarIndex[id] || (appState.lugaresCache || []).find(l => String(l._id) === String(id));
    }

    function openLugarModal(lugar) {
      try {
        const backdrop = document.getElementById('lugarModalBackdrop');
        const title = document.getElementById('modalTitle');
        const categoria = document.getElementById('modalCategoria');
        const desc = document.getElementById('modalDesc');
        if (title) title.textContent = lugar.nombre || 'Sin nombre';
        if (categoria) categoria.textContent = (lugar.categoria && (lugar.categoria.nombre || lugar.categoria)) || (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
        if (desc) desc.textContent = lugar.descripcion || 'Muy pronto añadiremos una descripción detallada.';
        const maps = document.getElementById('modalMaps');
        if (maps) maps.href = lugar.googleMapsLink || lugar.maps || '#';
        renderModalMeta(lugar);
        renderModalTags(lugar);
        prepareModalGallery(lugar);
        const modalFav = document.getElementById('modalFav');
        if (modalFav) {
          modalFav.dataset.favId = lugar._id || '';
        }
        if (backdrop) {
          backdrop.style.display = 'flex';
          backdrop.setAttribute('aria-hidden', 'false');
        }
        updateFavoriteButtons();
        const reviewsLoader = document.getElementById('publicReviewsLoader');
        if (reviewsLoader) reviewsLoader.hidden = false;
        const lugarId = getLugarIdentifier(lugar);
        appState.reviewsByLugar[lugarId] = [];
        renderModalReviews(lugarId);
        loadLugarReviews(lugarId);
      } catch (e) { console.error(e); }
    }

    function hideLugarModal() {
      const backdrop = document.getElementById('lugarModalBackdrop');
      if (!backdrop) return;
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
    }

    function bindModalClose() {
      const closeBtn = document.getElementById('modalCloseBtn');
      if (!closeBtn || closeBtn.dataset.bound === 'true') return;
      closeBtn.dataset.bound = 'true';
      closeBtn.addEventListener('click', hideLugarModal);
    }

    function bindModalKeyboardNavigation() {
      if (modalKeyboardBound) return;
      const backdrop = document.getElementById('lugarModalBackdrop');
      if (!backdrop) return;
      document.addEventListener('keydown', (event) => {
        if (backdrop.getAttribute('aria-hidden') === 'true') return;
        if (event.key === 'Escape') {
          hideLugarModal();
          return;
        }
      });
      modalKeyboardBound = true;
    }

    async function loadLugares(options = {}) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      const filters = getActiveFilters();
      const params = new URLSearchParams();
      if (filters.q) params.set('q', filters.q);
      if (filters.categoria) params.set('categoria', filters.categoria);

      if (!options.silent) {
        grid.innerHTML = '<div class="col-span-full text-center py-12">Buscando lugares...</div>';
      }

      if (searchControl.controller) searchControl.controller.abort();
      const controller = new AbortController();
      searchControl.controller = controller;

      let list = [];
      try {
        const url = params.toString() ? `/api/lugares?${params.toString()}` : '/api/lugares';
        const res = await fetch(url, { credentials: 'include', signal: controller.signal });
        if (!res.ok) throw new Error('lugares');
        const payload = await res.json();
        list = Array.isArray(payload) ? payload : (Array.isArray(payload.lugares) ? payload.lugares : []);
        searchControl.warned = false;
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.warn('No se pudo cargar /api/lugares', err);
        if (!searchControl.warned) {
          notify('warning', {
            title: 'Mostrando datos de ejemplo',
            message: 'No pudimos obtener los lugares en vivo. Intenta refrescar más tarde.'
          });
          searchControl.warned = true;
        }
        const cached = Array.isArray(window.__lugares_cache) && window.__lugares_cache.length ? window.__lugares_cache.slice() : [];
        list = cached.length ? cached : fallbackLugares.slice();
      }

      window.__lugares_cache = list.slice();
      const filtered = filterListLocally(list, filters);
      renderLugares(filtered);
      if (!searchControl.categoriesLoaded || options.refreshCategories) {
        populateCategoryFilter(list, { force: true });
        searchControl.categoriesLoaded = true;
      }
    }

    function populateCategoryFilter(list, { force = false } = {}) {
      const sel = safeQuery('#categoryFilter');
      if (!sel || !Array.isArray(list)) return;
      if (searchControl.categoriesLoaded && !force) return;
      const cats = Array.from(new Set(list.map(l => (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '').filter(Boolean))).sort();
      sel.innerHTML = '<option value="">Todas las categorías</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
      if (!filtersState.bound) {
        sel.addEventListener('change', scheduleSearch);
        const search = safeQuery('#searchInput'); if (search) search.addEventListener('input', scheduleSearch);
        filtersState.bound = true;
      }
    }

    function renderLugares(list) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      appState.lugaresCache = list.slice();
      appState.lugarIndex = {};
      list.forEach(item => {
        if (item && item._id) appState.lugarIndex[String(item._id)] = item;
      });
      window.__lugares_cache = list.slice();
      if (!list || !list.length) {
        grid.innerHTML = '<div class="col-span-full text-center py-12 muted">No se encontraron lugares.</div>';
        return;
      }
      grid.innerHTML = '';
      list.forEach(l => grid.appendChild(createLugarCard(l)));
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
      updateFavoriteButtons();
    }

    function updateFavoriteButtons() {
      const ids = appState.favoriteIds;
      document.querySelectorAll('[data-fav-id]').forEach(btn => {
        const id = btn.getAttribute('data-fav-id');
        if (!id) return;
        const active = ids.has(String(id));
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        const label = btn.querySelector('.fav-label');
        if (label) label.textContent = active ? 'Guardado' : 'Favorito';
      });
    }

    function renderModalReviews(lugarId) {
      const list = safeQuery('#publicReviewsList');
      const empty = safeQuery('#publicReviewsEmpty');
      if (!list || !empty) return;
      const reviews = appState.reviewsByLugar[lugarId] || [];
      if (!reviews.length) {
        list.innerHTML = '';
        empty.hidden = false;
        return;
      }
      empty.hidden = true;
      list.innerHTML = reviews.map(review => {
        const rating = typeof review.rating === 'number' ? review.rating : Number(review.rating) || 0;
        return `
          <div class="modal-review-item">
            <strong>${review.autorNombre || 'Visitante'}</strong>
            <span class="review-rating" style="margin-left:0.5rem;">${rating.toFixed(1)} ★</span>
            <small>${formatDate(review.createdAt || review.fecha)}</small>
            <p class="text-sm mt-2 text-[#4b372b]">${review.comment || review.comentario || ''}</p>
          </div>
        `;
      }).join('');
    }

    async function loadLugarReviews(lugarId) {
      const loader = safeQuery('#publicReviewsLoader');
      const empty = safeQuery('#publicReviewsEmpty');
      const list = safeQuery('#publicReviewsList');
      if (!lugarId || !loader || !empty || !list) return;
      loader.hidden = false;
      empty.hidden = true;
      list.innerHTML = '';
      try {
        const res = await fetch(`/api/lugares/${lugarId}/reviews`);
        if (!res.ok) throw new Error('public-reviews');
        const data = await res.json();
        const reviews = Array.isArray(data) ? data : (Array.isArray(data.reviews) ? data.reviews : []);
        appState.reviewsByLugar[lugarId] = reviews;
      } catch (error) {
        console.warn('No se pudieron cargar las reseñas públicas', error);
        appState.reviewsByLugar[lugarId] = [];
        empty.textContent = 'No se pudieron cargar las reseñas. Intenta más tarde.';
        empty.hidden = false;
      } finally {
        loader.hidden = true;
        renderModalReviews(lugarId);
      }
    }

    async function toggleFavorite() {
      await showAuthPrompt();
    }

    document.addEventListener('click', (e) => {
      const favBtn = e.target.closest('[data-fav-id]');
      if (favBtn) {
        e.preventDefault();
        toggleFavorite(favBtn.dataset.favId, favBtn);
        return;
      }
      const detailBtn = e.target.closest('.btn-detail');
      if (detailBtn) {
        const card = detailBtn.closest('[data-lugar-id]');
        const lugar = card ? (getLugarById(card.dataset.lugarId) || card.__lugarData) : null;
        if (lugar) openLugarModal(lugar);
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      bindModalClose();
      bindModalCarouselControls();
      bindModalKeyboardNavigation();
      renderFavoritesSection();
      initImmersiveTour();
      await loadLugares({ refreshCategories: true });
    });
  </script>
</body>
</html>
