<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MinerApp — Real del Monte</title>
  <meta name="theme-color" content="#4f46e5">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Playball&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/user.css">

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .fade-in { opacity: 0; transform: translateY(18px); transition: opacity .7s ease, transform .7s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); }
  </style>
</head>
<body class="bg-white text-gray-800 scroll-smooth">

  <div id="user-header-container"></div>

  <!-- Hero -->
  <section id="inicio" class="min-h-screen flex flex-col items-center justify-center text-center p-8">
    <h2 class="text-5xl md:text-6xl font-extrabold mb-4 text-black">MinerApp</h2>
    <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-2xl">Tu aventura en Real del Monte comienza aquí: rutas, historia y los mejores lugares para visitar.</p>

    <div class="flex gap-4 mb-10">
      <a href="/user/login" class="bg-black text-white px-5 py-2 rounded-lg hover:bg-gray-800 transition">Iniciar sesión</a>
      <a href="/user/register" class="border border-gray-300 px-5 py-2 rounded-lg hover:bg-gray-100 transition text-gray-800">Regístrate</a>
    </div>

    <div class="max-w-5xl w-full">
      <img src="https://www.viajabonito.mx/wp-content/uploads/2019/12/real-del-monte-pueblo-minero-100.jpg" alt="Mineral del Monte" class="rounded-2xl shadow-lg w-full object-cover">
    </div>
  </section>

  <!-- Historia -->
  <section id="historia" class="py-20 bg-white">
    <div class="max-w-6xl mx-auto px-6 md:px-10 space-y-20">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">¿Sabías que?</h3>
          <p class="text-gray-700 leading-relaxed text-lg">El Conde de Regla hizo su fortuna con la plata de Real del Monte; hoy es un pueblo lleno de historia y tradiciones.</p>
        </div>
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://www.eluniversalhidalgo.com.mx/resizer/v2/WPEAUPUVKFDX7JX6DIIZYK7KZA.jpeg" alt="Calles de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT9R-uUl4kbG_Y7tNroD5tU_GjoWu_oSS0Q_g&s" alt="Kiosko de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">La herencia británica</h3>
          <p class="text-gray-700 leading-relaxed text-lg mb-5">Gracias a los mineros de Cornualles, Real del Monte es la cuna del fútbol y del paste en México.</p>
          <a href="#lugares" class="inline-block bg-black text-white px-6 py-3 rounded-xl hover:bg-gray-800 transition">Descubre lugares</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Lugares -->
  <section id="lugares" class="py-16 px-6 bg-gray-50 text-gray-800">
    <div class="max-w-6xl mx-auto">
      <h3 class="text-3xl font-bold text-center mb-8">Lugares destacados</h3>

      <div class="mb-6 flex items-center justify-between gap-4">
        <div class="flex-1">
          <input id="searchInput" type="search" placeholder="Buscar lugares, categorías o descripciones..." class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div>
          <select id="categoryFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">Todas las categorías</option>
          </select>
        </div>
      </div>

      <div id="lugaresGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards serán inyectadas aquí por JS -->
      </div>
    </div>
  </section>

  <div id="user-footer-container"></div>

  <script src="/js/user.js"></script>
  <script>
    // Safe helpers to avoid runtime errors when elements are missing
    function safeQuery(selector) { return document.querySelector(selector); }

    function createLugarCard(lugar) {
      const card = document.createElement('article');
      card.className = 'bg-white rounded-2xl p-5 shadow-sm hover:shadow-md transition fade-in';
      const imagen = (lugar.images && lugar.images.length) ? lugar.images[0] : 'https://via.placeholder.com/400x300?text=Sin+Imagen';
      const categoria = lugar.categoria ? (lugar.categoria.nombre || lugar.categoria) : (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
      const mapsLink = lugar.googleMapsLink || '#';

      card.innerHTML = `
        <div class="h-40 rounded-lg overflow-hidden mb-4">
          <img src="${imagen}" alt="${lugar.nombre || 'Lugar'}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400x300?text=Imagen+no+disponible'">
        </div>
        <h4 class="text-xl text-pink-600 mb-1" style="font-family: 'Playball', cursive;">${lugar.nombre || 'Sin nombre'}</h4>
        <p class="text-sm text-slate-600">${lugar.descripcion || 'Sin descripción'}</p>
        <div class="mt-3 text-sm">
          <p><span class="font-semibold">Categoría:</span> ${categoria}</p>
        </div>
        <div class="flex gap-2 mt-4">
          <a href="${mapsLink}" target="_blank" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition">Ver ubicación</a>
          <button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition" onclick="addToFavorites('${lugar._id || ''}')">Agregar a favoritos</button>
        </div>
      `;

      return card;
    }

    function addToFavorites(id) { if (!id) return alert('ID no disponible'); alert('Funcionalidad de favoritos en desarrollo'); }

    async function loadLugares() {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      // mostrar loader simple
      grid.innerHTML = '<div class="col-span-full text-center py-12">Cargando lugares...</div>';
      try {
        const res = await fetch('/api/lugares');
        if (res.ok) {
          const payload = await res.json();
          // API devuelve { lugares: [...] } — soportar ambas formas
          const list = Array.isArray(payload) ? payload : (Array.isArray(payload.lugares) ? payload.lugares : []);
          console.log('Lugares cargados (cliente):', list.length);
          renderLugares(list);
          populateCategoryFilter(list);
          return;
        }
      } catch (err) {
        console.warn('No se pudo cargar /api/lugares', err);
      }

      // Mock de ejemplo si no hay backend
      const mock = [
        { _id: '1', nombre: 'Mina Acosta', descripcion: 'Visitas guiadas por las antiguas minas.', images: [] , categoria: 'Museo' },
        { _id: '2', nombre: 'Museo del Sitio', descripcion: 'Conoce la historia minera.', images: [], categoria: 'Museo' },
        { _id: '3', nombre: 'Pastes', descripcion: 'Prueba el paste tradicional.', images: [], categoria: 'Gastronomía' }
      ];
      renderLugares(mock);
      populateCategoryFilter(mock);
    }

    function populateCategoryFilter(list) {
      const sel = safeQuery('#categoryFilter');
      if (!sel) return;
      const cats = Array.from(new Set(list.map(l => (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '').filter(Boolean)) ).sort();
      // limpiar y añadir opciones
      sel.innerHTML = '<option value="">Todas las categorías</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
      sel.addEventListener('change', applyFilters);
      const search = safeQuery('#searchInput'); if (search) search.addEventListener('input', applyFilters);
    }

    function applyFilters() {
      const q = (safeQuery('#searchInput') && safeQuery('#searchInput').value || '').toLowerCase();
      const cat = (safeQuery('#categoryFilter') && safeQuery('#categoryFilter').value) || '';
      const items = window.__lugares_cache || [];
      const filtered = items.filter(l => {
        const text = ((l.nombre || '') + ' ' + (l.descripcion || '') + ' ' + ((l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '')).toLowerCase();
        const okText = !q || text.includes(q);
        const okCat = !cat || ( (l.categoria && (l.categoria.nombre || l.categoria)) === cat ) || (l.categoriaId && l.categoriaId.nombre === cat);
        return okText && okCat;
      });
      renderLugares(filtered);
    }

    function renderLugares(list) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      window.__lugares_cache = list.slice(); // cache para filtros
      if (!list || !list.length) {
        grid.innerHTML = '<div class="col-span-full text-center py-12 muted">No se encontraron lugares.</div>';
        return;
      }
      grid.innerHTML = '';
      list.forEach(l => grid.appendChild(createLugarCard(l)));
      // activar animaciones
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadLugares();
    });
  </script>
</body>
</html>
