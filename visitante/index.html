<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MinerApp — Real del Monte</title>
  <meta name="theme-color" content="#4f46e5">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Playball&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/user.css">

  <style>
    body { font-family: 'Poppins', sans-serif; background:#fff7ef; color:#2f1e16; }
    .fade-in { opacity: 0; transform: translateY(18px); transition: opacity .7s ease, transform .7s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    .glass { background: rgba(255,247,236,0.72); backdrop-filter: blur(6px); border:1px solid rgba(213,176,109,0.25); }
    .heritage-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:rgba(212,164,65,0.22); font-size:0.85rem; color:#7b4316; font-weight:600; }
  </style>
</head>
<body class="bg-[#fff7ef] text-[#3c2b22] scroll-smooth">

  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-[#f6dcc4] shadow-sm">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between gap-4 relative">
      <a href="/visitante" class="flex items-center gap-3" aria-label="Ir al inicio">
        <div class="w-10 h-10 bg-gradient-to-tr from-rose-400 to-indigo-500 rounded-lg flex items-center justify-center shadow-md">
          <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11c2.761 0 5-2.239 5-5S14.761 1 12 1 7 3.239 7 6s2.239 5 5 5z"/></svg>
        </div>
        <div>
          <p class="text-lg font-bold leading-tight text-[#3d2619]">Real del Monte</p>
          <p class="text-xs text-[#a6825a] uppercase tracking-wide">Visitante</p>
        </div>
      </a>

      <button type="button" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-full border border-[#f2d5b3] text-[#5b4639]" data-nav-toggle aria-controls="visitante-nav" aria-expanded="false" aria-label="Abrir menú">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7h16M4 12h16M4 17h16"/></svg>
      </button>

      <nav id="visitante-nav" data-nav-menu aria-hidden="true" role="navigation" aria-label="Menú principal visitante" class="fixed inset-y-0 right-0 z-40 flex w-72 max-w-[85vw] flex-col gap-2 bg-white/95 border-l border-[#f2d5b3] shadow-2xl px-5 py-6 transform translate-x-full transition-transform duration-300 ease-out pointer-events-none md:pointer-events-auto md:static md:inset-auto md:w-auto md:max-w-none md:flex-row md:items-center md:bg-transparent md:border-0 md:shadow-none md:px-0 md:py-0 md:translate-x-0">
        <div class="w-full flex items-center justify-between mb-4 md:hidden">
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-[#a6825a]">Menú</p>
          <button type="button" class="text-sm text-[#5b4639] px-2 py-1" data-nav-close aria-label="Cerrar menú">Cerrar ✕</button>
        </div>
        <a href="#inicio" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l9-8 9 8v7a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2z"/></svg>
          Inicio
        </a>
                <a href="#historia" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 19.5A2.5 2.5 0 016.5 17h11A2.5 2.5 0 0120 19.5V21H4z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 3h12v14H6z"/></svg>
          Historia
        </a>
        <a href="#favoritos" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 21.364 4.318 12.682a4.5 4.5 0 010-6.364z"/></svg>
          Favoritos
        </a>

        <a href="#lugares" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h2l3.6 7.59a1 1 0 00.9.59H17a1 1 0 00.95-.68L20 6H6"/><circle cx="9" cy="19" r="2"/><circle cx="17" cy="19" r="2"/></svg>
          Lugares
        </a>
        <button type="button" data-logout class="nav-link px-4 py-2 rounded-md text-sm flex items-center gap-2 bg-rose-500 text-white hover:bg-rose-600 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4-4-4m4 4H9"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"/></svg>
          Cerrar sesión
        </button>
      </nav>
    </div>
    <div class="md:hidden fixed inset-0 z-30 bg-black/40 opacity-0 pointer-events-none transition-opacity duration-300" data-nav-backdrop></div>
  </header>

  <!-- Hero -->
  <section id="inicio" class="relative min-h-screen w-full flex flex-col items-center justify-center text-center px-4 py-16 sm:px-8 sm:py-20 overflow-hidden" style="background: radial-gradient(circle at top, rgba(212,164,65,0.25), transparent 55%), linear-gradient(135deg,#fff4e4 0%, #ffe4c1 60%, #fbe7d1 100%);">
    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
      <div class="absolute -top-10 -left-10 w-48 h-48 bg-white/30 rounded-full blur-3xl"></div>
      <div class="absolute bottom-5 right-5 w-56 h-56 bg-[#3a5a40]/10 rounded-full blur-3xl"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center gap-6">
      <span class="heritage-pill">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 13l9 8 9-8-9-8z"/></svg>
        Real del Monte • Pueblo Mágico
      </span>
      <h2 class="text-4xl sm:text-5xl md:text-6xl font-extrabold leading-tight text-[#4b2a13]">
        MinerApp
        <span class="block text-xl sm:text-2xl md:text-3xl font-semibold text-[#b45309]">La guía premium para explorar minas, historia y gastronomía</span>
      </h2>
      <p class="text-base sm:text-lg md:text-xl text-[#5b4639] max-w-3xl">
        Paletas cálidas inspiradas en cantera, hierro y bosque minero para sumergirte en la esencia realista de Real del Monte.
      </p>

      <div class="flex flex-col sm:flex-row flex-wrap gap-4 mb-6 justify-center w-full sm:w-auto">
        <a href="#lugares" class="brand-cta px-6 py-3 rounded-2xl text-white text-sm uppercase tracking-wide">Explorar lugares</a>
        <a href="#favoritos" class="glass px-6 py-3 rounded-2xl text-sm font-semibold text-[#3a2d25] hover:-translate-y-0.5 transition">Ver mis favoritos</a>
      </div>

      <div class="max-w-5xl w-full px-2 sm:px-0">
        <img src="https://www.viajabonito.mx/wp-content/uploads/2019/12/real-del-monte-pueblo-minero-100.jpg" alt="Mineral del Monte" class="rounded-3xl shadow-xl w-full object-cover border border-[#f0d4aa]">
      </div>
    </div>
  </section>

  <!-- Favoritos personalizados -->
  <section id="favoritos" class="py-16 px-4 sm:px-6 bg-[#fffaf4] border-t border-[#f6dcc4]">
    <div class="max-w-6xl mx-auto space-y-10">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-6 justify-between">
        <div>
          <p class="text-sm uppercase tracking-[0.3em] text-[#c06a1c]">Colección personal</p>
          <h3 class="text-3xl font-extrabold text-[#422515] mt-2">Tus tesoros favoritos de Real del Monte</h3>
          <p id="favoritesSubtitle" class="text-[#6b4a3b] mt-3 max-w-2xl">Tus favoritos se sincronizan automáticamente con tu cuenta.</p>
        </div>
        <div>
          <a id="favoritesAction" href="#lugares" class="brand-cta inline-flex items-center gap-2 px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
            Explorar lugares
          </a>
        </div>
      </div>
      <div id="favoritesEmpty" class="favorites-empty text-center text-[#7a5c4a] bg-white/70 rounded-3xl border border-[#f1dac9] py-10 px-6">
        Aún no tienes favoritos guardados. Agrega lugares tocando el corazón en cada tarjeta.
      </div>
      <div id="favoritesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- Historia -->
  <section id="historia" class="py-16 sm:py-20 bg-white">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 md:px-10 space-y-16 sm:space-y-20">
      <div class="grid md:grid-cols-2 gap-8 sm:gap-10 items-center">
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">¿Sabías que?</h3>
          <p class="text-gray-700 leading-relaxed text-lg">El Conde de Regla hizo su fortuna con la plata de Real del Monte; hoy es un pueblo lleno de historia y tradiciones.</p>
        </div>
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://www.mexicoescultura.com/galerias/espacios/principal/real.jpg" alt="Calles de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-8 sm:gap-10 items-center">
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT9R-uUl4kbG_Y7tNroD5tU_GjoWu_oSS0Q_g&s" alt="Kiosko de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">La herencia británica</h3>
          <p class="text-gray-700 leading-relaxed text-lg mb-5">Gracias a los mineros de Cornualles, Real del Monte es la cuna del fútbol y del paste en México.</p>
          <a href="#lugares" class="inline-block brand-cta px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">Descubre lugares</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Lugares -->
  <section id="lugares" class="py-16 px-4 sm:px-6" style="background: linear-gradient(180deg,#fff0de 0%, #fff7ef 60%, #fffdf8 100%); color:#3c2b22;">
    <div class="max-w-6xl mx-auto">
      <h3 class="text-3xl font-bold text-center mb-8">Lugares destacados</h3>

      <div class="mb-6 flex flex-col md:flex-row items-stretch md:items-center gap-4">
        <div class="w-full md:flex-1">
          <input id="searchInput" type="search" placeholder="Buscar lugares, categorías o descripciones..." class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="w-full md:w-auto">
          <select id="categoryFilter" class="border border-slate-200 rounded-lg px-3 py-2 w-full md:w-56">
            <option value="">Todas las categorías</option>
          </select>
        </div>
      </div>

      <div id="lugaresGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards serán inyectadas aquí por JS -->
      </div>
    </div>
  </section>

      <!-- Modal detalle -->
      <div id="lugarModalBackdrop" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <button class="close-btn" id="modalCloseBtn" aria-label="Cerrar">✕</button>
          <div class="modal-body">
            <div class="modal-gallery" id="modalGallery">
              <div class="carousel" id="modalCarousel" aria-live="polite">
                <button type="button" class="ctrl left" data-carousel-prev aria-label="Imagen anterior">‹</button>
                <div class="carousel-frame">
                  <img id="modalCarouselImage" class="carousel-img" src="https://via.placeholder.com/800x600?text=Sin+Imagen" alt="Galería del lugar" loading="lazy" />
                </div>
                <button type="button" class="ctrl right" data-carousel-next aria-label="Imagen siguiente">›</button>
                <div class="carousel-counter" id="modalCarouselCounter"></div>
              </div>
              <div class="carousel-indicators" id="modalCarouselIndicators"></div>
            </div>
            <div class="modal-info">
              <p id="modalCategoria" class="chip modal-badge mb-2"></p>
              <h2 id="modalTitle" class="text-3xl font-extrabold mb-3"></h2>
              <p id="modalDesc" class="modal-desc mb-4"></p>
              <div id="modalMeta" class="modal-meta-grid"></div>
              <div id="modalTags" class="modal-tags"></div>
              <div class="modal-actions mt-6 flex gap-3 flex-wrap">
                <a id="modalMaps" class="brand-cta inline-block px-4 py-2 rounded-md" target="_blank" href="#">Ver en Maps</a>
                <button id="modalFav" type="button" class="fav-toggle" data-fav-id="">
                  <span class="fav-icon" aria-hidden="true">❤</span>
                  <span class="fav-label">Guardar</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

  <footer class="bg-[#1f130c] text-[#fbead6] border-t border-[#f6dcc4] mt-20">
    <div class="max-w-6xl mx-auto px-6 py-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
      <div>
        <p class="text-lg font-bold">MinerApp Visitante</p>
        <p class="text-sm text-[#d6b28e]">Experiencia personalizada para quienes ya forman parte de la comunidad.</p>
      </div>
      <div class="flex flex-wrap gap-4 text-sm uppercase tracking-[0.2em] text-[#f7d8b3]">
        <a href="#inicio" class="hover:text-white transition">Inicio</a>
                <a href="#historia" class="hover:text-white transition">Historia</a>    
        <a href="#favoritos" class="hover:text-white transition">Favoritos</a>
        <a href="#lugares" class="hover:text-white transition">Lugares</a>
      </div>
    </div>
  </footer>

  <!-- Prompt de autenticación removido para visitantes autenticados -->

  <script src="/js/alerts.js"></script>
  <script>
    const appState = {
      currentUser: null,
      favoriteIds: new Set(),
      favoritesList: [],
      lugaresCache: [],
      lugarIndex: {}
    };

    const filtersState = { bound: false };
    const navState = { toggle: null, menu: null, backdrop: null, media: null };
    const searchControl = { timer: null, controller: null, warned: false, categoriesLoaded: false };
    const fallbackLugares = [
      { _id: '1', nombre: 'Mina Acosta', descripcion: 'Visitas guiadas por las antiguas minas.', images: [] , categoria: 'Museo' },
      { _id: '2', nombre: 'Museo del Sitio', descripcion: 'Conoce la historia minera.', images: [], categoria: 'Museo' },
      { _id: '3', nombre: 'Pastes', descripcion: 'Prueba el paste tradicional.', images: [], categoria: 'Gastronomía' }
    ];

    function notify(type, config) {
      if (window.alertCenter && typeof window.alertCenter[type] === 'function') {
        return window.alertCenter[type](config);
      }
      const msg = typeof config === 'string' ? config : (config && config.message) || 'Acción completada';
      return alert(msg);
    }

    function safeQuery(selector) { return document.querySelector(selector); }

    function setNavMenuVisibility(visible) {
      const { menu, toggle, backdrop, media } = navState;
      if (!menu || !toggle) return;
      if (media && media.matches) return;
      const showMenu = Boolean(visible);
      menu.classList.toggle('translate-x-0', showMenu);
      menu.classList.toggle('translate-x-full', !showMenu);
      menu.classList.toggle('pointer-events-none', !showMenu);
      menu.setAttribute('aria-hidden', showMenu ? 'false' : 'true');
      toggle.setAttribute('aria-expanded', showMenu ? 'true' : 'false');
      document.body.classList.toggle('overflow-hidden', showMenu);
      if (backdrop) {
        backdrop.classList.toggle('opacity-100', showMenu);
        backdrop.classList.toggle('pointer-events-none', !showMenu);
      }
    }

    function collapseNavMenu() {
      if (navState.media && navState.media.matches) return;
      setNavMenuVisibility(false);
    }

    function attachLogoutHandlers() {
      document.querySelectorAll('[data-logout]').forEach(btn => {
        if (btn.dataset.logoutBound === 'true') return;
        btn.dataset.logoutBound = 'true';
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          collapseNavMenu();
          handleLogout(btn);
        });
      });
    }

    async function handleLogout(trigger) {
      const btn = trigger || document.querySelector('[data-logout]');
      const label = btn ? btn.querySelector('span') : null;
      if (btn) btn.disabled = true;
      if (label) label.dataset.originalText = label.textContent;
      if (label) label.textContent = 'Cerrando...';
      try {
        await fetch('/user/logout', { method: 'POST', credentials: 'include' });
      } catch (err) {
        console.warn('No se pudo cerrar sesión', err);
      } finally {
        window.location.href = '/';
      }
    }

    function initVisitorNav() {
      navState.toggle = document.querySelector('[data-nav-toggle]');
      navState.menu = document.querySelector('[data-nav-menu]');
      navState.backdrop = document.querySelector('[data-nav-backdrop]');
      navState.media = window.matchMedia('(min-width: 768px)');
      const { toggle, menu } = navState;
      if (!toggle || !menu) return;

      const handleBreakpoint = () => {
        if (navState.media.matches) {
          menu.classList.remove('translate-x-full');
          menu.classList.remove('pointer-events-none');
          menu.classList.add('md:translate-x-0');
          menu.setAttribute('aria-hidden', 'false');
          document.body.classList.remove('overflow-hidden');
          toggle.setAttribute('aria-expanded', 'false');
          if (navState.backdrop) {
            navState.backdrop.classList.add('pointer-events-none');
            navState.backdrop.classList.remove('opacity-100');
          }
          return;
        }
        menu.classList.add('translate-x-full');
        menu.classList.remove('translate-x-0');
        menu.classList.add('pointer-events-none');
        menu.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('overflow-hidden');
        toggle.setAttribute('aria-expanded', 'false');
        if (navState.backdrop) {
          navState.backdrop.classList.add('pointer-events-none');
          navState.backdrop.classList.remove('opacity-100');
        }
      };

      handleBreakpoint();
      if (navState.media.addEventListener) {
        navState.media.addEventListener('change', handleBreakpoint);
      } else if (navState.media.addListener) {
        navState.media.addListener(handleBreakpoint);
      }

      toggle.addEventListener('click', () => {
        const isOpen = menu.classList.contains('translate-x-0');
        setNavMenuVisibility(!isOpen);
      });

      if (navState.backdrop) {
        navState.backdrop.addEventListener('click', () => setNavMenuVisibility(false));
      }

      menu.querySelectorAll('a[href^="#"]').forEach(link => {
        link.addEventListener('click', () => {
          collapseNavMenu();
        });
      });
      menu.querySelectorAll('[data-nav-close]').forEach(btn => {
        btn.addEventListener('click', () => collapseNavMenu());
      });
      attachLogoutHandlers();
    }

    async function fetchSession() {
      try {
        const res = await fetch('/api/session', { credentials: 'include' });
        if (!res.ok) throw new Error('session');
        const data = await res.json();
        if (!data.authenticated) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para continuar.' });
          window.location.href = '/user/login';
          return;
        }
        appState.currentUser = data.user;
        if (Array.isArray(data.favoriteIds)) {
          applyFavoriteIds(data.favoriteIds);
        }
      } catch (err) {
        notify('error', { title: 'Sesión no disponible', message: 'Por seguridad te redirigimos al inicio de sesión.' });
        setTimeout(() => { window.location.href = '/user/login'; }, 800);
        return;
      }
    }

    function applyFavoriteIds(ids) {
      if (!Array.isArray(ids)) return;
      appState.favoriteIds = new Set(ids.map(String));
      updateFavoriteButtons();
    }

    async function fetchFavorites() {
      if (!appState.currentUser) {
        appState.favoriteIds = new Set();
        appState.favoritesList = [];
        renderFavoritesSection();
        updateFavoriteButtons();
        return;
      }
      try {
        const res = await fetch('/api/favorites', { credentials: 'include' });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para ver tus favoritos.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('favorites');
        const data = await res.json();
        const raw = Array.isArray(data.favorites) ? data.favorites : [];
        appState.favoritesList = raw.map(f => f.lugar).filter(Boolean);
        appState.favoriteIds = new Set(appState.favoritesList.map(l => String(l._id)));
      } catch (err) {
        console.warn('No se pudieron cargar favoritos', err);
        appState.favoritesList = [];
        notify('info', {
          title: 'Sincronización pendiente',
          message: 'Tus favoritos aparecerán en cuanto recuperemos la conexión.'
        });
      }
      renderFavoritesSection();
      updateFavoriteButtons();
    }

    function renderFavoritesSection() {
      const grid = safeQuery('#favoritesGrid');
      const empty = safeQuery('#favoritesEmpty');
      if (!grid || !empty) return;
      if (!appState.favoritesList.length) {
        empty.textContent = 'Aún no guardas lugares. Pulsa el corazón para tener acceso rápido aquí.';
        empty.style.display = '';
        grid.innerHTML = '';
        return;
      }
      empty.style.display = 'none';
      grid.innerHTML = '';
      appState.favoritesList.forEach(lugar => grid.appendChild(createLugarCard(lugar)));
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
    }

    function getActiveFilters() {
      const search = safeQuery('#searchInput');
      const category = safeQuery('#categoryFilter');
      return {
        q: (search && search.value ? search.value.trim() : ''),
        categoria: (category && category.value) || ''
      };
    }

    function filterListLocally(list, filters) {
      if (!Array.isArray(list) || !list.length) return [];
      const q = (filters.q || '').toLowerCase();
      const categoria = filters.categoria || '';
      return list.filter(l => {
        const text = ((l.nombre || '') + ' ' + (l.descripcion || '') + ' ' + ((l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '')).toLowerCase();
        const matchesText = !q || text.includes(q);
        const catValue = (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '';
        const matchesCat = !categoria || catValue === categoria;
        return matchesText && matchesCat;
      });
    }

    function scheduleSearch() {
      if (searchControl.timer) clearTimeout(searchControl.timer);
      searchControl.timer = setTimeout(() => {
        loadLugares({ refreshCategories: false, fromSearch: true, silent: true });
      }, 220);
    }

    function createLugarCard(lugar) {
      const card = document.createElement('article');
      card.className = 'bg-white rounded-2xl p-0 shadow-sm hover:shadow-md transition fade-in lugar-card';
      const lugarId = String(lugar._id || lugar.id || lugar.nombre || Math.random());
      card.dataset.lugarId = lugarId;
      card.__lugarData = lugar;
      const imagen = (lugar.images && lugar.images.length) ? lugar.images[0] : 'https://via.placeholder.com/400x300?text=Sin+Imagen';
      const categoria = lugar.categoria ? (lugar.categoria.nombre || lugar.categoria) : (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
      const mapsLink = lugar.googleMapsLink || '#';

      card.innerHTML = `
        <div class="thumb-wrapper">
          <img src="${imagen}" alt="${lugar.nombre || 'Lugar'}" class="thumb" onerror="this.src='https://via.placeholder.com/400x300?text=Imagen+no+disponible'">
        </div>
        <div class="lugar-meta">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h4 class="lugar-title mb-1">${lugar.nombre || 'Sin nombre'}</h4>
              <p class="lugar-desc text-sm">${(lugar.descripcion || '').slice(0,140)}${(lugar.descripcion && lugar.descripcion.length>140)?'...':''}</p>
            </div>
            <button type="button" class="fav-toggle" data-fav-id="${lugarId}" aria-pressed="false">
              <span class="fav-icon" aria-hidden="true">❤</span>
              <span class="fav-label">Favorito</span>
            </button>
          </div>
          <div class="lugar-actions mt-3 flex items-center justify-between flex-wrap gap-3">
            <span class="chip">${categoria}</span>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-md text-sm border btn-detail">Ver detalles</button>
              <a href="${mapsLink}" target="_blank" class="px-3 py-2 rounded-md text-sm brand-cta">Maps</a>
            </div>
          </div>
        </div>
      `;

      return card;
    }

    function getLugarById(id) {
      if (!id) return null;
      return appState.lugarIndex[id] || (appState.lugaresCache || []).find(l => String(l._id) === String(id));
    }

    function openLugarModal(lugar) {
      try {
        const backdrop = document.getElementById('lugarModalBackdrop');
        document.getElementById('modalTitle').textContent = lugar.nombre || 'Sin nombre';
        document.getElementById('modalCategoria').textContent = (lugar.categoria && (lugar.categoria.nombre || lugar.categoria)) || (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
        document.getElementById('modalDesc').textContent = lugar.descripcion || '';
        document.getElementById('modalMeta').textContent = lugar.tags ? 'Tags: ' + (Array.isArray(lugar.tags)?lugar.tags.join(', '):lugar.tags) : '';
        const maps = document.getElementById('modalMaps');
        maps.href = lugar.googleMapsLink || '#';
        const gallery = document.getElementById('modalGallery');
        gallery.innerHTML = '';
        const imgs = (lugar.images && lugar.images.length) ? lugar.images : ['https://via.placeholder.com/800x600?text=Sin+Imagen'];
        imgs.forEach(src => { const i = document.createElement('img'); i.src = src; i.className = 'thumb'; gallery.appendChild(i); });
        const modalFav = document.getElementById('modalFav');
        if (modalFav) {
          modalFav.dataset.favId = lugar._id || '';
        }
        backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden', 'false');
        updateFavoriteButtons();
      } catch (e) { console.error(e); }
    }

    function bindModalClose() {
      const closeBtn = document.getElementById('modalCloseBtn');
      if (closeBtn) closeBtn.addEventListener('click', () => {
        const b = document.getElementById('lugarModalBackdrop'); if (b) { b.style.display = 'none'; b.setAttribute('aria-hidden','true'); }
      });
    }

    async function loadLugares(options = {}) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      const filters = getActiveFilters();
      const params = new URLSearchParams();
      if (filters.q) params.set('q', filters.q);
      if (filters.categoria) params.set('categoria', filters.categoria);

      if (!options.silent) {
        grid.innerHTML = '<div class="col-span-full text-center py-12">Buscando lugares...</div>';
      }

      if (searchControl.controller) searchControl.controller.abort();
      const controller = new AbortController();
      searchControl.controller = controller;

      let list = [];
      try {
        const url = params.toString() ? `/api/lugares?${params.toString()}` : '/api/lugares';
        const res = await fetch(url, { credentials: 'include', signal: controller.signal });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para seguir explorando.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('lugares');
        const payload = await res.json();
        list = Array.isArray(payload) ? payload : (Array.isArray(payload.lugares) ? payload.lugares : []);
        if (Array.isArray(payload.favoriteIds)) applyFavoriteIds(payload.favoriteIds);
        searchControl.warned = false;
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.warn('No se pudo cargar /api/lugares', err);
        if (!searchControl.warned) {
          notify('warning', {
            title: 'Mostrando datos de ejemplo',
            message: 'No pudimos conectarnos al servidor. Intenta de nuevo más tarde.'
          });
          searchControl.warned = true;
        }
        const cached = Array.isArray(window.__lugares_cache) && window.__lugares_cache.length ? window.__lugares_cache.slice() : [];
        list = cached.length ? cached : fallbackLugares.slice();
      }

      window.__lugares_cache = list.slice();
      const filtered = filterListLocally(list, filters);
      renderLugares(filtered);
      if (!searchControl.categoriesLoaded || options.refreshCategories) {
        populateCategoryFilter(list, { force: true });
        searchControl.categoriesLoaded = true;
      }
    }

    function populateCategoryFilter(list, { force = false } = {}) {
      const sel = safeQuery('#categoryFilter');
      if (!sel || !Array.isArray(list)) return;
      if (searchControl.categoriesLoaded && !force) return;
      const cats = Array.from(new Set(list.map(l => (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '').filter(Boolean))).sort();
      sel.innerHTML = '<option value="">Todas las categorías</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
      if (!filtersState.bound) {
        sel.addEventListener('change', scheduleSearch);
        const search = safeQuery('#searchInput'); if (search) search.addEventListener('input', scheduleSearch);
        filtersState.bound = true;
      }
    }

    function renderLugares(list) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      appState.lugaresCache = list.slice();
      appState.lugarIndex = {};
      list.forEach(item => {
        if (item && item._id) appState.lugarIndex[String(item._id)] = item;
      });
      window.__lugares_cache = list.slice();
      if (!list || !list.length) {
        grid.innerHTML = '<div class="col-span-full text-center py-12 muted">No se encontraron lugares.</div>';
        return;
      }
      grid.innerHTML = '';
      list.forEach(l => grid.appendChild(createLugarCard(l)));
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
      updateFavoriteButtons();
    }

    function updateFavoriteButtons() {
      const ids = appState.favoriteIds;
      document.querySelectorAll('[data-fav-id]').forEach(btn => {
        const id = btn.getAttribute('data-fav-id');
        if (!id) return;
        const active = ids.has(String(id));
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        const label = btn.querySelector('.fav-label');
        if (label) label.textContent = active ? 'Guardado' : 'Favorito';
      });
    }

    async function toggleFavorite(lugarId, triggerEl) {
      if (!lugarId) return;
      if (!appState.currentUser) {
        window.location.href = '/user/login';
        return;
      }
      const isFav = appState.favoriteIds.has(String(lugarId));
      if (triggerEl) triggerEl.disabled = true;
      try {
        const res = await fetch(`/api/favorites/${lugarId}`, {
          method: isFav ? 'DELETE' : 'POST',
          credentials: 'include'
        });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para seguir guardando lugares.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('favorite');
        await fetchFavorites();
        notify('success', { message: isFav ? 'Favorito eliminado' : 'Agregado a favoritos' });
      } catch (err) {
        console.error('No se pudo actualizar favorito', err);
        notify('error', { title: 'Sin cambios', message: 'No pudimos actualizar tu favorito. Intenta más tarde.' });
      } finally {
        if (triggerEl) triggerEl.disabled = false;
        updateFavoriteButtons();
      }
    }

    document.addEventListener('click', (e) => {
      const favBtn = e.target.closest('[data-fav-id]');
      if (favBtn) {
        e.preventDefault();
        toggleFavorite(favBtn.dataset.favId, favBtn);
        return;
      }
      const detailBtn = e.target.closest('.btn-detail');
      if (detailBtn) {
        const card = detailBtn.closest('[data-lugar-id]');
        const lugar = card ? (getLugarById(card.dataset.lugarId) || card.__lugarData) : null;
        if (lugar) openLugarModal(lugar);
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      bindModalClose();
      initVisitorNav();
      attachLogoutHandlers();
      await fetchSession();
      await loadLugares({ refreshCategories: true });
      await fetchFavorites();
    });
  </script>
</body>
</html>
