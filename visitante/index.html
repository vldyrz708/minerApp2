<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MinerApp — Real del Monte</title>
  <meta name="theme-color" content="#4f46e5">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Playball&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/user.css">

  <style>
    body { font-family: 'Poppins', sans-serif; background:#fff7ef; color:#2f1e16; }
    .fade-in { opacity: 0; transform: translateY(18px); transition: opacity .7s ease, transform .7s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    .glass { background: rgba(255,247,236,0.72); backdrop-filter: blur(6px); border:1px solid rgba(213,176,109,0.25); }
    .heritage-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:rgba(212,164,65,0.22); font-size:0.85rem; color:#7b4316; font-weight:600; }
    .tour-panel { display:flex; flex-direction:column; gap:1.5rem; }
    .tour-hints { padding:1.25rem; border-radius:1.25rem; background:linear-gradient(120deg,rgba(236,204,171,0.25),rgba(255,255,255,0.65)); border:1px solid rgba(199,161,120,0.45); box-shadow:0 15px 30px rgba(60,43,34,0.08) inset; }
    .tour-hints-title { font-size:0.95rem; font-weight:600; text-transform:uppercase; letter-spacing:0.15em; color:#b45309; margin-bottom:0.75rem; display:block; }
    .tour-hints-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:0.65rem; color:#5b4639; font-size:0.9rem; }
    .tour-hints-list li { display:flex; gap:0.65rem; align-items:flex-start; line-height:1.35; }
    .tour-hint-icon { width:1.65rem; height:1.65rem; border-radius:999px; background:#fff; border:1px solid rgba(180,83,9,0.35); display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem; color:#b45309; box-shadow:0 4px 8px rgba(60,43,34,0.08); flex-shrink:0; }
    .reviews-shell { background:#fffaf4; border-radius:1.5rem; border:1px solid rgba(212,164,65,0.25); padding:1.5rem; box-shadow:0 20px 35px rgba(60,43,34,0.08); }
    .review-card { border:1px solid rgba(99,71,54,0.12); border-radius:1.25rem; padding:1rem 1.25rem; background:white; display:flex; flex-direction:column; gap:0.5rem; }
    .review-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .review-rating { display:inline-flex; align-items:center; gap:0.35rem; font-weight:600; color:#b45309; background:rgba(180,83,9,0.08); border-radius:999px; padding:0.15rem 0.75rem; }
    .review-meta { font-size:0.85rem; color:#7b5a46; }
    .review-empty { text-align:center; padding:2rem; border-radius:1.25rem; background:rgba(255,255,255,0.7); border:1px dashed rgba(99,71,54,0.2); color:#7a5c4a; }
    .modal-reviews { margin-top:2rem; border-top:1px solid rgba(99,71,54,0.15); padding-top:1.5rem; }
    .reviews-heading { display:flex; flex-direction:column; gap:0.4rem; margin-bottom:1.25rem; }
    .reviews-eyebrow { text-transform:uppercase; letter-spacing:0.3em; font-size:0.72rem; font-weight:700; color:#c06a1c; }
    .reviews-heading h3 { font-size:1.15rem; font-weight:700; color:#3c2b22; margin:0; }
    .reviews-subheading { font-size:0.9rem; color:#7a5c4a; }
    .modal-review-list { display:flex; flex-direction:column; gap:0.75rem; max-height:220px; overflow:auto; padding-right:0.25rem; }
    .modal-review-item { border:1px solid rgba(60,43,34,0.12); border-radius:1rem; padding:0.85rem 1rem; background:#fff; }
    .modal-review-item small { display:block; color:#7b5a46; font-size:0.75rem; margin-top:0.25rem; }
    .review-form { margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .review-form select,
    .review-form textarea { width:100%; border:1px solid rgba(60,43,34,0.25); border-radius:0.75rem; padding:0.75rem; font-size:0.9rem; }
    .review-form-actions { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
    .review-ghost-form { margin-top:1rem; padding:1rem 1.25rem; border-radius:1rem; border:1px dashed rgba(180,83,9,0.35); background:rgba(180,83,9,0.06); display:flex; flex-direction:column; gap:0.65rem; }
    .review-ghost-form strong { font-size:0.95rem; color:#4b2a13; }
    .review-actions { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem; }
    .review-action { border:1px solid rgba(180,83,9,0.35); border-radius:999px; padding:0.35rem 0.95rem; font-size:0.8rem; font-weight:600; color:#a34719; background:rgba(255,255,255,0.9); transition:background .2s ease, color .2s ease; }
    .review-action:hover { background:rgba(180,83,9,0.08); }
    .review-action.danger { border-color:rgba(220,38,38,0.35); color:#b91c1c; }
    .review-action.danger:hover { background:rgba(220,38,38,0.12); color:#7f1d1d; }
    .review-auth-alert { margin-top:1rem; padding:1rem; border-radius:1rem; border:1px dashed rgba(180,83,9,0.4); background:rgba(180,83,9,0.07); color:#7b4316; font-size:0.9rem; }
    .reviews-refresh { border:1px solid rgba(180,83,9,0.4); color:#b45309; padding:0.65rem 1rem; border-radius:999px; font-size:0.85rem; font-weight:600; }
    .reviews-refresh:hover { background:rgba(180,83,9,0.08); }
    @media (max-width: 640px) {
      .tour-hints { padding:1rem; }
      .tour-hints-list { font-size:0.85rem; }
      .modal-review-list { max-height:180px; }
    }
  </style>
</head>
<body class="bg-[#fff7ef] text-[#3c2b22] scroll-smooth" data-google-maps-key="">

  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-[#f6dcc4] shadow-sm">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between gap-4 relative">
      <a href="/visitante" class="flex items-center gap-3" aria-label="Ir al inicio">
        <div class="w-10 h-10 bg-gradient-to-tr from-rose-400 to-indigo-500 rounded-lg flex items-center justify-center shadow-md">
          <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11c2.761 0 5-2.239 5-5S14.761 1 12 1 7 3.239 7 6s2.239 5 5 5z"/></svg>
        </div>
        <div>
          <p class="text-lg font-bold leading-tight text-[#3d2619]">Real del Monte</p>
          <p class="text-xs text-[#a6825a] uppercase tracking-wide">Visitante</p>
        </div>
      </a>

      <button type="button" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-full border border-[#f2d5b3] text-[#5b4639]" data-nav-toggle aria-controls="visitante-nav" aria-expanded="false" aria-label="Abrir menú">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7h16M4 12h16M4 17h16"/></svg>
      </button>

      <nav id="visitante-nav" data-nav-menu aria-hidden="true" role="navigation" aria-label="Menú principal visitante" class="fixed inset-y-0 right-0 z-40 flex w-72 max-w-[85vw] flex-col gap-2 bg-white/95 border-l border-[#f2d5b3] shadow-2xl px-5 py-6 transform translate-x-full transition-transform duration-300 ease-out pointer-events-none md:pointer-events-auto md:static md:inset-auto md:w-auto md:max-w-none md:flex-row md:items-center md:bg-transparent md:border-0 md:shadow-none md:px-0 md:py-0 md:translate-x-0">
        <div class="w-full flex items-center justify-between mb-4 md:hidden">
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-[#a6825a]">Menú</p>
          <button type="button" class="text-sm text-[#5b4639] px-2 py-1" data-nav-close aria-label="Cerrar menú">Cerrar ✕</button>
        </div>
        <a href="#inicio" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l9-8 9 8v7a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2z"/></svg>
          Inicio
        </a>
                <a href="#historia" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 19.5A2.5 2.5 0 016.5 17h11A2.5 2.5 0 0120 19.5V21H4z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 3h12v14H6z"/></svg>
          Historia
        </a>
        <a href="#favoritos" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 21.364 4.318 12.682a4.5 4.5 0 010-6.364z"/></svg>
          Favoritos
        </a>

        <a href="#lugares" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h2l3.6 7.59a1 1 0 00.9.59H17a1 1 0 00.95-.68L20 6H6"/><circle cx="9" cy="19" r="2"/><circle cx="17" cy="19" r="2"/></svg>
          Lugares
        </a>
        <a href="/visitante/mis-resenas.html" class="nav-link px-3 py-2 rounded-md text-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"/></svg>
          Mis reseñas
        </a>
        <button type="button" data-logout class="nav-link px-4 py-2 rounded-md text-sm flex items-center gap-2 bg-rose-500 text-white hover:bg-rose-600 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4-4-4m4 4H9"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"/></svg>
          Cerrar sesión
        </button>
      </nav>
    </div>
    <div class="md:hidden fixed inset-0 z-30 bg-black/40 opacity-0 pointer-events-none transition-opacity duration-300" data-nav-backdrop></div>
  </header>

  <!-- Hero -->
  <section id="inicio" class="relative min-h-screen w-full flex flex-col items-center justify-center text-center px-4 py-16 sm:px-8 sm:py-20 overflow-hidden" style="background: radial-gradient(circle at top, rgba(212,164,65,0.25), transparent 55%), linear-gradient(135deg,#fff4e4 0%, #ffe4c1 60%, #fbe7d1 100%);">
    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
      <div class="absolute -top-10 -left-10 w-48 h-48 bg-white/30 rounded-full blur-3xl"></div>
      <div class="absolute bottom-5 right-5 w-56 h-56 bg-[#3a5a40]/10 rounded-full blur-3xl"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center gap-6">
      <span class="heritage-pill">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 13l9 8 9-8-9-8z"/></svg>
        Real del Monte • Pueblo Mágico
      </span>
      <h2 class="text-4xl sm:text-5xl md:text-6xl font-extrabold leading-tight text-[#4b2a13]">
        MinerApp
        <span class="block text-xl sm:text-2xl md:text-3xl font-semibold text-[#b45309]">La guía premium para explorar minas, historia y gastronomía</span>
      </h2>
      <p class="text-base sm:text-lg md:text-xl text-[#5b4639] max-w-3xl">
        Paletas cálidas inspiradas en cantera, hierro y bosque minero para sumergirte en la esencia realista de Real del Monte.
      </p>

      <div class="flex flex-col sm:flex-row flex-wrap gap-4 mb-6 justify-center w-full sm:w-auto">
        <a href="#lugares" class="brand-cta px-6 py-3 rounded-2xl text-white text-sm uppercase tracking-wide">Explorar lugares</a>
        <a href="#favoritos" class="glass px-6 py-3 rounded-2xl text-sm font-semibold text-[#3a2d25] hover:-translate-y-0.5 transition">Ver mis favoritos</a>
      </div>

      <div class="max-w-5xl w-full px-2 sm:px-0">
        <img src="https://www.viajabonito.mx/wp-content/uploads/2019/12/real-del-monte-pueblo-minero-100.jpg" alt="Mineral del Monte" class="rounded-3xl shadow-xl w-full object-cover border border-[#f0d4aa]">
      </div>
    </div>
  </section>

  <!-- Favoritos personalizados -->
  <section id="favoritos" class="py-16 px-4 sm:px-6 bg-[#fffaf4] border-t border-[#f6dcc4]">
    <div class="max-w-6xl mx-auto space-y-10">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-6 justify-between">
        <div>
          <p class="text-sm uppercase tracking-[0.3em] text-[#c06a1c]">Colección personal</p>
          <h3 class="text-3xl font-extrabold text-[#422515] mt-2">Tus tesoros favoritos de Real del Monte</h3>
          <p id="favoritesSubtitle" class="text-[#6b4a3b] mt-3 max-w-2xl">Tus favoritos se sincronizan automáticamente con tu cuenta.</p>
        </div>
        <div>
          <a id="favoritesAction" href="#lugares" class="brand-cta inline-flex items-center gap-2 px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
            Explorar lugares
          </a>
        </div>
      </div>
      <div id="favoritesEmpty" class="favorites-empty text-center text-[#7a5c4a] bg-white/70 rounded-3xl border border-[#f1dac9] py-10 px-6">
        Aún no tienes favoritos guardados. Agrega lugares tocando el corazón en cada tarjeta.
      </div>
      <div id="favoritesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- Mis reseñas CTA -->
  <section id="mis-resenas" class="py-16 px-4 sm:px-6 bg-white border-t border-[#f6dcc4]">
    <div class="max-w-6xl mx-auto grid gap-10 md:grid-cols-2 items-center">
      <div class="space-y-4">
        <p class="text-sm uppercase tracking-[0.3em] text-[#c06a1c]">Tu voz cuenta</p>
        <h3 class="text-3xl font-extrabold text-[#422515]">Panel de reseñas</h3>
        <p class="text-[#6b4a3b] leading-relaxed">Explora todas tus reseñas, edita comentarios anteriores y consulta métricas personales en un panel dedicado. Diseñamos una vista completa para que controles cada detalle de tu experiencia.</p>
        <ul class="list-disc pl-5 text-[#5b4639] space-y-2">
          <li>Historial completo con filtros por categoría y calificación.</li>
          <li>Accesos directos para editar o eliminar reseñas en segundos.</li>
          <li>Estadísticas personales para seguir tu impacto en la comunidad.</li>
        </ul>
        <div class="flex flex-wrap gap-4 pt-4">
          <a href="/visitante/mis-resenas.html" class="brand-cta px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">Abrir panel especializado</a>
          <button type="button" class="reviews-refresh" data-reviews-refresh>Sincronizar datos</button>
        </div>
      </div>
      <div class="reviews-shell space-y-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-200 to-rose-100 flex items-center justify-center text-[#b45309] font-bold">4.8★</div>
          <div>
            <p class="text-sm uppercase tracking-[0.3em] text-[#c06a1c]">Vista previa</p>
            <p class="text-[#422515] font-semibold">Más contexto en el nuevo panel</p>
          </div>
        </div>
        <div class="review-card space-y-3">
          <div class="review-header">
            <div>
              <p class="font-semibold text-[#3c2b22]">Museo del Sitio</p>
              <span class="review-meta">Jun 2024 · Patrimonio</span>
            </div>
            <span class="review-rating">5.0 ★</span>
          </div>
          <p class="text-sm text-[#4b372b]">"La nueva museografía te guía por toda la historia minera. Recomiendo pedir el recorrido teatralizado."</p>
          <div class="review-actions">
            <span class="review-action">Explorar</span>
            <span class="review-action">Ver estadísticas</span>
          </div>
        </div>
        <div class="rounded-2xl border border-dashed border-[#f1dac9] p-4 text-sm text-[#6b4a3b] bg-[#fffaf4]">
          Accede al panel dedicado para revisar cada comentario con más herramientas, notas privadas y filtros avanzados.
        </div>
      </div>
    </div>
  </section>

  <!-- Historia -->
  <section id="historia" class="py-16 sm:py-20 bg-white">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 md:px-10 space-y-16 sm:space-y-20">
      <div class="grid md:grid-cols-2 gap-8 sm:gap-10 items-center">
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">¿Sabías que?</h3>
          <p class="text-gray-700 leading-relaxed text-lg">El Conde de Regla hizo su fortuna con la plata de Real del Monte; hoy es un pueblo lleno de historia y tradiciones.</p>
        </div>
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://www.mexicoescultura.com/galerias/espacios/principal/real.jpg" alt="Calles de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-8 sm:gap-10 items-center">
        <div class="fade-in overflow-hidden rounded-2xl shadow-md">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT9R-uUl4kbG_Y7tNroD5tU_GjoWu_oSS0Q_g&s" alt="Kiosko de Real del Monte" class="w-full h-64 md:h-80 object-cover rounded-2xl">
        </div>
        <div>
          <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="font-family: 'Playball', cursive;">La herencia británica</h3>
          <p class="text-gray-700 leading-relaxed text-lg mb-5">Gracias a los mineros de Cornualles, Real del Monte es la cuna del fútbol y del paste en México.</p>
          <a href="#lugares" class="inline-block brand-cta px-6 py-3 rounded-2xl text-sm uppercase tracking-wide">Descubre lugares</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Recorrido inmersivo -->
  <section id="tour" class="py-16 px-4 sm:px-6 bg-[#fffaf4] border-t border-[#f6dcc4]">
    <div class="max-w-6xl mx-auto space-y-10">
      <div class="tour-heading flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="tour-eyebrow">Recorrido inmersivo</p>
          <h3 class="text-3xl font-extrabold text-[#422515]">Activa Street View y planea tus visitas</h3>
          <p class="text-[#5b4639] max-w-2xl mt-3">Explora túneles y plazas antes de llegar. Añade tu clave de Google Maps para desbloquear el modo Street View interactivo.</p>
        </div>
        <div class="tour-status-chip" data-tour-status>
          <span class="dot" aria-hidden="true"></span>
          <span data-tour-status-label>Street View activo</span>
        </div>
      </div>

<div class="tour-shell">
        <div class="tour-media" data-tour-media>
          <iframe
            id="tourIframe"
            class="tour-iframe"
            title="Recorrido inmersivo por Real del Monte"
            allowfullscreen
            loading="lazy"
            src="https://www.google.com/maps/embed?pb=!4v1719525250327!6m8!1m7!1sCAoSLEFGMVFpcE5Yd29GWGhPWG5tN1EtQmtXUnpQMlM3Y1I0MngzN0dCMUpncVZh!2m2!1d20.1367594!2d-98.6723357!3f120!4f5!5f0.7820865974627469"
          ></iframe>
          <div id="streetViewCanvas" class="streetview-canvas" hidden aria-hidden="true"></div>
          <div class="tour-loader" data-tour-loading hidden>
            <span class="loader-dot" aria-hidden="true"></span>
            <p>Preparando Street View...</p>
          </div>
          <p class="tour-fallback" data-tour-fallback hidden>
            Agrega tu API key de Google Maps en <code>data-google-maps-key</code> para desbloquear Street View.
          </p>
        </div>
        <div class="tour-panel">
          <ol id="tourStopsList" class="tour-stops"></ol>
          <div class="tour-hints" aria-live="polite" aria-label="Instrucciones de Street View">
            <span class="tour-hints-title">Cómo usar Street View</span>
            <ul class="tour-hints-list">
              <li>
                <span class="tour-hint-icon">↻</span>
                Usa el mouse o tu dedo para girar y explorar cada rincón.
              </li>
              <li>
                <span class="tour-hint-icon">＋</span>
                Acerca o aleja con los controles + / - para ver más detalle.
              </li>
              <li>
                <span class="tour-hint-icon">⚠</span>
                Si no aparece Street View, puede que la zona aún no tenga cobertura.
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Lugares -->
  <section id="lugares" class="py-16 px-4 sm:px-6" style="background: linear-gradient(180deg,#fff0de 0%, #fff7ef 60%, #fffdf8 100%); color:#3c2b22;">
    <div class="max-w-6xl mx-auto">
      <h3 class="text-3xl font-bold text-center mb-8">Lugares destacados</h3>

      <div class="mb-6 flex flex-col md:flex-row items-stretch md:items-center gap-4">
        <div class="w-full md:flex-1">
          <input id="searchInput" type="search" placeholder="Buscar lugares, categorías o descripciones..." class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="w-full md:w-auto">
          <select id="categoryFilter" class="border border-slate-200 rounded-lg px-3 py-2 w-full md:w-56">
            <option value="">Todas las categorías</option>
          </select>
        </div>
      </div>

      <div id="lugaresGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards serán inyectadas aquí por JS -->
      </div>
    </div>
  </section>

      <!-- Modal detalle -->
      <div id="lugarModalBackdrop" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <button class="close-btn" id="modalCloseBtn" aria-label="Cerrar">✕</button>
          <div class="modal-body">
            <div class="modal-gallery" id="modalGallery">
              <div class="carousel" id="modalCarousel" aria-live="polite">
                <button type="button" class="ctrl left" data-carousel-prev aria-label="Imagen anterior">‹</button>
                <div class="carousel-frame">
                  <img id="modalCarouselImage" class="carousel-img" src="https://via.placeholder.com/800x600?text=Sin+Imagen" alt="Galería del lugar" loading="lazy" />
                </div>
                <button type="button" class="ctrl right" data-carousel-next aria-label="Imagen siguiente">›</button>
                <div class="carousel-counter" id="modalCarouselCounter"></div>
              </div>
              <div class="carousel-indicators" id="modalCarouselIndicators"></div>
            </div>
            <div class="modal-info">
              <p id="modalCategoria" class="chip modal-badge mb-2"></p>
              <h2 id="modalTitle" class="text-3xl font-extrabold mb-3"></h2>
              <p id="modalDesc" class="modal-desc mb-4"></p>
              <div id="modalMeta" class="modal-meta-grid"></div>
              <div id="modalTags" class="modal-tags"></div>
              <div class="modal-actions mt-6 flex gap-3 flex-wrap">
                <a id="modalMaps" class="brand-cta inline-block px-4 py-2 rounded-md" target="_blank" href="#">Ver en Maps</a>
                <button id="modalFav" type="button" class="fav-toggle" data-fav-id="">
                  <span class="fav-icon" aria-hidden="true">❤</span>
                  <span class="fav-label">Guardar</span>
                </button>
              </div>
              <div class="modal-reviews" id="placeReviewsContainer">
                <div class="reviews-heading">
                  <span class="reviews-eyebrow">Reseñas verificadas</span>
                  <h3>Opiniones de la comunidad</h3>
                  <p class="reviews-subheading">Historias auténticas de exploradores que ya vivieron Real del Monte.</p>
                </div>
                <div id="placeReviewsLoader" class="review-empty">Cargando reseñas...</div>
                <div id="placeReviewsList" class="modal-review-list"></div>
                <p id="placeReviewsEmpty" class="review-empty" hidden>Sé la primera persona en compartir una reseña.</p>
                <div id="reviewAuthPrompt" class="review-auth-alert" hidden>
                  Necesitas iniciar sesión para dejar tu reseña. <a href="/user/login" class="underline font-semibold">Ir a iniciar sesión</a>.
                </div>
                <form id="reviewForm" class="review-form" novalidate>
                  <div class="flex flex-col gap-2">
                    <label for="reviewRating" class="font-semibold text-sm text-[#3c2b22]">Calificación</label>
                    <select id="reviewRating" name="rating" required>
                      <option value="5">5 - Excelente</option>
                      <option value="4">4 - Muy bueno</option>
                      <option value="3">3 - Bueno</option>
                      <option value="2">2 - Regular</option>
                      <option value="1">1 - Mejorable</option>
                    </select>
                  </div>
                  <div class="flex flex-col gap-2">
                    <label for="reviewComment" class="font-semibold text-sm text-[#3c2b22]">Comparte tu experiencia</label>
                    <textarea id="reviewComment" name="comment" rows="3" placeholder="¿Qué te encantó de este lugar?" required></textarea>
                  </div>
                  <div class="review-form-actions">
                    <button type="submit" class="brand-cta px-5 py-2 rounded-md text-sm" data-review-submit>Enviar reseña</button>
                    <button type="button" class="btn-ghost text-sm" data-review-cancel hidden>Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

  <footer class="bg-[#1f130c] text-[#fbead6] border-t border-[#f6dcc4] mt-20">
    <div class="max-w-6xl mx-auto px-6 py-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
      <div>
        <p class="text-lg font-bold">MinerApp Visitante</p>
        <p class="text-sm text-[#d6b28e]">Experiencia personalizada para quienes ya forman parte de la comunidad.</p>
      </div>
      <div class="flex flex-wrap gap-4 text-sm uppercase tracking-[0.2em] text-[#f7d8b3]">
        <a href="#inicio" class="hover:text-white transition">Inicio</a>
                <a href="#historia" class="hover:text-white transition">Historia</a>    
        <a href="#favoritos" class="hover:text-white transition">Favoritos</a>
        <a href="#lugares" class="hover:text-white transition">Lugares</a>
      </div>
    </div>
  </footer>

  <!-- Prompt de autenticación removido para visitantes autenticados -->

  <script src="/js/alerts.js"></script>
  <script>
    const appState = {
      currentUser: null,
      favoriteIds: new Set(),
      favoritesList: [],
      lugaresCache: [],
      lugarIndex: {},
      userReviews: [],
      reviewsByLugar: {},
      activeLugarId: null
    };

    const filtersState = { bound: false };
    const navState = { toggle: null, menu: null, backdrop: null, media: null };
    const searchControl = { timer: null, controller: null, warned: false, categoriesLoaded: false };
    const fallbackLugares = [
      { _id: '1', nombre: 'Mina Acosta', descripcion: 'Visitas guiadas por las antiguas minas.', images: [] , categoria: 'Museo' },
      { _id: '2', nombre: 'Museo del Sitio', descripcion: 'Conoce la historia minera.', images: [], categoria: 'Museo' },
      { _id: '3', nombre: 'Pastes', descripcion: 'Prueba el paste tradicional.', images: [], categoria: 'Gastronomía' }
    ];
    const immersiveTourConfig = {
      stops: [
        {
          id: 'mina-acosta',
          title: 'Mina Acosta',
          description: 'Ingresa a los túneles con maquinaria restaurada.',
          badge: 'Entrada principal',
          position: { lat: 20.13676, lng: -98.67233 },
          pov: { heading: 125, pitch: -5, zoom: 1 }
        },
        {
          id: 'plaza-principal',
          title: 'Plaza Juárez',
          description: 'Colores coloniales y la vida diaria del centro.',
          badge: 'Centro histórico',
          position: { lat: 20.13532, lng: -98.67205 },
          pov: { heading: 200, pitch: 0, zoom: 1 }
        },
        {
          id: 'museo-sitio',
          title: 'Museo del Sitio',
          description: 'Exposiciones que narran la bonanza minera.',
          badge: 'Museo',
          position: { lat: 20.13781, lng: -98.67382 },
          pov: { heading: 75, pitch: -2, zoom: 1 }
        }
      ]
    };
    const streetViewState = {
      sdkPromise: null,
      panorama: null,
      mode: 'idle',
      activeStop: 0,
      loading: false
    };

    function notify(type, config) {
      if (window.alertCenter && typeof window.alertCenter[type] === 'function') {
        return window.alertCenter[type](config);
      }
      const msg = typeof config === 'string' ? config : (config && config.message) || 'Acción completada';
      return alert(msg);
    }

    function safeQuery(selector) { return document.querySelector(selector); }

    function formatDate(value) {
      if (!value) return '';
      try {
        return new Date(value).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (_) {
        return value;
      }
    }

    function getLugarIdentifier(lugar) {
      if (!lugar) return '';
      return String(lugar._id || lugar.id || lugar.nombre || '');
    }

    function getGoogleMapsKey() {
      const { dataset } = document.body || {};
      return dataset && dataset.googleMapsKey ? dataset.googleMapsKey.trim() : '';
    }

    function ensureGoogleMapsSdk(key) {
      if (window.google && window.google.maps) {
        return Promise.resolve(window.google.maps);
      }
      if (!key) return Promise.reject(new Error('missing-key'));
      if (!streetViewState.sdkPromise) {
        streetViewState.sdkPromise = new Promise((resolve, reject) => {
          const existing = document.getElementById('google-maps-sdk');
          if (existing && existing.getAttribute('data-loaded')) {
            resolve(window.google.maps);
            return;
          }
          const script = existing || document.createElement('script');
          script.id = 'google-maps-sdk';
          script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&v=quarterly`;
          script.async = true;
          script.defer = true;
          script.onload = () => {
            script.setAttribute('data-loaded', 'true');
            resolve(window.google.maps);
          };
          script.onerror = () => reject(new Error('sdk-load-error'));
          if (!existing) document.head.appendChild(script);
        });
      }
      return streetViewState.sdkPromise;
    }

    function updateTourStatus(mode) {
      const chip = document.querySelector('[data-tour-status]');
      const label = document.querySelector('[data-tour-status-label]');
      if (!chip || !label) return;
      const message = {
        idle: 'Street View inactivo',
        streetview: 'Street View activo',
        loading: 'Preparando Street View'
      };
      label.textContent = message[mode] || message.idle;
      chip.setAttribute('data-mode', mode);
    }

    function showTourFallback(message) {
      const fallback = document.querySelector('[data-tour-fallback]');
      if (!fallback) return;
      if (message) fallback.innerHTML = message;
      fallback.hidden = false;
    }

    function hideTourFallback() {
      const fallback = document.querySelector('[data-tour-fallback]');
      if (fallback) fallback.hidden = true;
    }

    function setTourLoaderVisible(visible) {
      const loader = document.querySelector('[data-tour-loading]');
      if (loader) loader.hidden = !visible;
    }

    function setStreetViewPosition(index = 0) {
      if (!streetViewState.panorama) return;
      const stop = immersiveTourConfig.stops[index] || immersiveTourConfig.stops[0];
      if (!stop) return;
      streetViewState.panorama.setPosition(stop.position);
      if (stop.pov) streetViewState.panorama.setPov(stop.pov);
      streetViewState.activeStop = index;
    }

    async function activateStreetView(index = 0) {
      const canvas = document.getElementById('streetViewCanvas');
      if (!canvas) return;
      const key = getGoogleMapsKey();
      if (!key) {
        showTourFallback('Agrega tu API key de Google Maps en el atributo <code>data-google-maps-key</code> del <code>&lt;body&gt;</code>.');
        streetViewState.mode = 'idle';
        updateTourStatus('idle');
        return;
      }
      hideTourFallback();
      setTourLoaderVisible(true);
      updateTourStatus('loading');
      try {
        const maps = await ensureGoogleMapsSdk(key);
        canvas.hidden = false;
        canvas.setAttribute('aria-hidden', 'false');
        if (!streetViewState.panorama) {
          streetViewState.panorama = new maps.StreetViewPanorama(canvas, {
            addressControl: false,
            fullscreenControl: true,
            motionTracking: false,
            zoomControl: true,
            visible: true
          });
        }
        streetViewState.mode = 'streetview';
        setStreetViewPosition(index);
        updateTourStatus('streetview');
      } catch (error) {
        console.error('No se pudo iniciar Street View', error);
        streetViewState.mode = 'idle';
        showTourFallback('No pudimos iniciar Street View. Revisa tu clave y vuelve a intentarlo.');
        updateTourStatus('idle');
      } finally {
        setTourLoaderVisible(false);
      }
    }

    function initImmersiveTour() {
      const canvas = document.getElementById('streetViewCanvas');
      if (!canvas) return;
      canvas.hidden = true;
      canvas.setAttribute('aria-hidden', 'true');
      streetViewState.activeStop = 0;
      streetViewState.mode = 'idle';
      updateTourStatus('idle');
      activateStreetView(0);
    }

    function setNavMenuVisibility(visible) {
      const { menu, toggle, backdrop, media } = navState;
      if (!menu || !toggle) return;
      if (media && media.matches) return;
      const showMenu = Boolean(visible);
      menu.classList.toggle('translate-x-0', showMenu);
      menu.classList.toggle('translate-x-full', !showMenu);
      menu.classList.toggle('pointer-events-none', !showMenu);
      menu.setAttribute('aria-hidden', showMenu ? 'false' : 'true');
      toggle.setAttribute('aria-expanded', showMenu ? 'true' : 'false');
      document.body.classList.toggle('overflow-hidden', showMenu);
      if (backdrop) {
        backdrop.classList.toggle('opacity-100', showMenu);
        backdrop.classList.toggle('pointer-events-none', !showMenu);
      }
    }

    function collapseNavMenu() {
      if (navState.media && navState.media.matches) return;
      setNavMenuVisibility(false);
    }

    function attachLogoutHandlers() {
      document.querySelectorAll('[data-logout]').forEach(btn => {
        if (btn.dataset.logoutBound === 'true') return;
        btn.dataset.logoutBound = 'true';
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          collapseNavMenu();
          handleLogout(btn);
        });
      });
    }

    async function handleLogout(trigger) {
      const btn = trigger || document.querySelector('[data-logout]');
      const label = btn ? btn.querySelector('span') : null;
      if (btn) btn.disabled = true;
      if (label) label.dataset.originalText = label.textContent;
      if (label) label.textContent = 'Cerrando...';
      try {
        await fetch('/user/logout', { method: 'POST', credentials: 'include' });
      } catch (err) {
        console.warn('No se pudo cerrar sesión', err);
      } finally {
        window.location.href = '/';
      }
    }

    function initVisitorNav() {
      navState.toggle = document.querySelector('[data-nav-toggle]');
      navState.menu = document.querySelector('[data-nav-menu]');
      navState.backdrop = document.querySelector('[data-nav-backdrop]');
      navState.media = window.matchMedia('(min-width: 768px)');
      const { toggle, menu } = navState;
      if (!toggle || !menu) return;

      const handleBreakpoint = () => {
        if (navState.media.matches) {
          menu.classList.remove('translate-x-full');
          menu.classList.remove('pointer-events-none');
          menu.classList.add('md:translate-x-0');
          menu.setAttribute('aria-hidden', 'false');
          document.body.classList.remove('overflow-hidden');
          toggle.setAttribute('aria-expanded', 'false');
          if (navState.backdrop) {
            navState.backdrop.classList.add('pointer-events-none');
            navState.backdrop.classList.remove('opacity-100');
          }
          return;
        }
        menu.classList.add('translate-x-full');
        menu.classList.remove('translate-x-0');
        menu.classList.add('pointer-events-none');
        menu.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('overflow-hidden');
        toggle.setAttribute('aria-expanded', 'false');
        if (navState.backdrop) {
          navState.backdrop.classList.add('pointer-events-none');
          navState.backdrop.classList.remove('opacity-100');
        }
      };

      handleBreakpoint();
      if (navState.media.addEventListener) {
        navState.media.addEventListener('change', handleBreakpoint);
      } else if (navState.media.addListener) {
        navState.media.addListener(handleBreakpoint);
      }

      toggle.addEventListener('click', () => {
        const isOpen = menu.classList.contains('translate-x-0');
        setNavMenuVisibility(!isOpen);
      });

      if (navState.backdrop) {
        navState.backdrop.addEventListener('click', () => setNavMenuVisibility(false));
      }

      menu.querySelectorAll('a[href^="#"]').forEach(link => {
        link.addEventListener('click', () => {
          collapseNavMenu();
        });
      });
      menu.querySelectorAll('[data-nav-close]').forEach(btn => {
        btn.addEventListener('click', () => collapseNavMenu());
      });
      attachLogoutHandlers();
    }

    async function fetchSession() {
      try {
        const res = await fetch('/api/session', { credentials: 'include' });
        if (!res.ok) throw new Error('session');
        const data = await res.json();
        if (!data.authenticated) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para continuar.' });
          window.location.href = '/user/login';
          return;
        }
        appState.currentUser = data.user;
        if (Array.isArray(data.favoriteIds)) {
          applyFavoriteIds(data.favoriteIds);
        }
      } catch (err) {
        notify('error', { title: 'Sesión no disponible', message: 'Por seguridad te redirigimos al inicio de sesión.' });
        setTimeout(() => { window.location.href = '/user/login'; }, 800);
        return;
      }
    }

    function applyFavoriteIds(ids) {
      if (!Array.isArray(ids)) return;
      appState.favoriteIds = new Set(ids.map(String));
      updateFavoriteButtons();
    }

    async function fetchFavorites() {
      if (!appState.currentUser) {
        appState.favoriteIds = new Set();
        appState.favoritesList = [];
        renderFavoritesSection();
        updateFavoriteButtons();
        return;
      }
      try {
        const res = await fetch('/api/favorites', { credentials: 'include' });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para ver tus favoritos.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('favorites');
        const data = await res.json();
        const raw = Array.isArray(data.favorites) ? data.favorites : [];
        appState.favoritesList = raw.map(f => f.lugar).filter(Boolean);
        appState.favoriteIds = new Set(appState.favoritesList.map(l => String(l._id)));
      } catch (err) {
        console.warn('No se pudieron cargar favoritos', err);
        appState.favoritesList = [];
        notify('info', {
          title: 'Sincronización pendiente',
          message: 'Tus favoritos aparecerán en cuanto recuperemos la conexión.'
        });
      }
      renderFavoritesSection();
      updateFavoriteButtons();
    }

    function renderFavoritesSection() {
      const grid = safeQuery('#favoritesGrid');
      const empty = safeQuery('#favoritesEmpty');
      if (!grid || !empty) return;
      if (!appState.favoritesList.length) {
        empty.textContent = 'Aún no guardas lugares. Pulsa el corazón para tener acceso rápido aquí.';
        empty.style.display = '';
        grid.innerHTML = '';
        return;
      }
      empty.style.display = 'none';
      grid.innerHTML = '';
      appState.favoritesList.forEach(lugar => grid.appendChild(createLugarCard(lugar)));
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
    }

    function renderUserReviewsSection() {
      const list = safeQuery('#userReviewsList');
      const empty = safeQuery('#userReviewsEmpty');
      if (!list || !empty) return;
      if (!appState.currentUser) {
        empty.textContent = 'Inicia sesión para comenzar a compartir tus reseñas.';
        empty.style.display = '';
        list.innerHTML = '';
        return;
      }
      if (!appState.userReviews.length) {
        empty.textContent = 'Aún no has calificado ningún lugar.';
        empty.style.display = '';
        list.innerHTML = '';
        return;
      }
      empty.style.display = 'none';
      list.innerHTML = appState.userReviews.map(review => {
        const rating = typeof review.rating === 'number' ? review.rating : Number(review.rating) || 0;
        const lugarId = review.lugarId || (review.lugar && review.lugar._id) || '';
        return `
          <article class="review-card" data-review-id="${review._id}" data-lugar-id="${lugarId}">
            <div class="review-header">
              <div>
                <p class="font-semibold text-[#3c2b22]">${review.lugarNombre || review.lugar?.nombre || 'Lugar'}</p>
                <span class="review-meta">${formatDate(review.createdAt || review.fecha)} · ${review.lugarCategoria || review.lugar?.categoria || ''}</span>
              </div>
              <span class="review-rating">${rating.toFixed(1)} ★</span>
            </div>
            <p class="text-sm text-[#4b372b]">${review.comment || review.comentario || ''}</p>
            <div class="review-actions">
              <button type="button" class="review-action" data-review-edit="${review._id}" data-lugar-id="${lugarId}">Editar</button>
              <button type="button" class="review-action danger" data-review-delete="${review._id}" data-lugar-id="${lugarId}">Eliminar</button>
            </div>
          </article>
        `;
      }).join('');
    }

    function getUserReviewForLugar(lugarId) {
      if (!lugarId || !Array.isArray(appState.userReviews)) return null;
      return appState.userReviews.find(review => String(review.lugarId || review.lugar) === String(lugarId)) || null;
    }

    async function fetchUserReviews(options = {}) {
      const { silent = false } = options;
      if (!appState.currentUser) {
        appState.userReviews = [];
        renderUserReviewsSection();
        return;
      }
      try {
        const res = await fetch('/api/reviews/mine', { credentials: 'include' });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para ver tus reseñas.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('user-reviews');
        const data = await res.json();
        const list = Array.isArray(data) ? data : (Array.isArray(data.reviews) ? data.reviews : []);
        appState.userReviews = list;
      } catch (err) {
        console.warn('No se pudieron cargar las reseñas del usuario', err);
        if (!silent) {
          notify('warning', { title: 'Reseñas no disponibles', message: 'Intenta actualizar tus reseñas más tarde.' });
        }
      }
      renderUserReviewsSection();
    }

    function getActiveFilters() {
      const search = safeQuery('#searchInput');
      const category = safeQuery('#categoryFilter');
      return {
        q: (search && search.value ? search.value.trim() : ''),
        categoria: (category && category.value) || ''
      };
    }

    function filterListLocally(list, filters) {
      if (!Array.isArray(list) || !list.length) return [];
      const q = (filters.q || '').toLowerCase();
      const categoria = filters.categoria || '';
      return list.filter(l => {
        const text = ((l.nombre || '') + ' ' + (l.descripcion || '') + ' ' + ((l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '')).toLowerCase();
        const matchesText = !q || text.includes(q);
        const catValue = (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '';
        const matchesCat = !categoria || catValue === categoria;
        return matchesText && matchesCat;
      });
    }

    function scheduleSearch() {
      if (searchControl.timer) clearTimeout(searchControl.timer);
      searchControl.timer = setTimeout(() => {
        loadLugares({ refreshCategories: false, fromSearch: true, silent: true });
      }, 220);
    }

    function createLugarCard(lugar) {
      const card = document.createElement('article');
      card.className = 'bg-white rounded-2xl p-0 shadow-sm hover:shadow-md transition fade-in lugar-card';
      const lugarId = String(lugar._id || lugar.id || lugar.nombre || Math.random());
      card.dataset.lugarId = lugarId;
      card.__lugarData = lugar;
      const imagen = (lugar.images && lugar.images.length) ? lugar.images[0] : 'https://via.placeholder.com/400x300?text=Sin+Imagen';
      const categoria = lugar.categoria ? (lugar.categoria.nombre || lugar.categoria) : (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
      const mapsLink = lugar.googleMapsLink || '#';

      card.innerHTML = `
        <div class="thumb-wrapper">
          <img src="${imagen}" alt="${lugar.nombre || 'Lugar'}" class="thumb" onerror="this.src='https://via.placeholder.com/400x300?text=Imagen+no+disponible'">
        </div>
        <div class="lugar-meta">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h4 class="lugar-title mb-1">${lugar.nombre || 'Sin nombre'}</h4>
              <p class="lugar-desc text-sm">${(lugar.descripcion || '').slice(0,140)}${(lugar.descripcion && lugar.descripcion.length>140)?'...':''}</p>
            </div>
            <button type="button" class="fav-toggle" data-fav-id="${lugarId}" aria-pressed="false">
              <span class="fav-icon" aria-hidden="true">❤</span>
              <span class="fav-label">Favorito</span>
            </button>
          </div>
          <div class="lugar-actions mt-3 flex items-center justify-between flex-wrap gap-3">
            <span class="chip">${categoria}</span>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-md text-sm border btn-detail">Ver detalles</button>
              <a href="${mapsLink}" target="_blank" class="px-3 py-2 rounded-md text-sm brand-cta">Maps</a>
            </div>
          </div>
        </div>
      `;

      return card;
    }

    function getLugarById(id) {
      if (!id) return null;
      return appState.lugarIndex[id] || (appState.lugaresCache || []).find(l => String(l._id) === String(id));
    }

    async function ensureLugarData(lugarId) {
      if (!lugarId) return null;
      const cached = getLugarById(lugarId);
      if (cached) return cached;
      try {
        const res = await fetch(`/api/lugares/${lugarId}`, { credentials: 'include' });
        if (!res.ok) throw new Error('lugar-not-found');
        const data = await res.json();
        const lugar = data.lugar || data;
        if (lugar && lugar._id) {
          appState.lugarIndex[String(lugar._id)] = lugar;
        }
        return lugar || null;
      } catch (error) {
        console.error('No se pudo obtener la información del lugar', error);
        return null;
      }
    }

    function openLugarModal(lugar, options = {}) {
      try {
        const backdrop = document.getElementById('lugarModalBackdrop');
        document.getElementById('modalTitle').textContent = lugar.nombre || 'Sin nombre';
        document.getElementById('modalCategoria').textContent = (lugar.categoria && (lugar.categoria.nombre || lugar.categoria)) || (lugar.categoriaId && lugar.categoriaId.nombre) || 'Sin categoría';
        document.getElementById('modalDesc').textContent = lugar.descripcion || '';
        document.getElementById('modalMeta').textContent = lugar.tags ? 'Tags: ' + (Array.isArray(lugar.tags)?lugar.tags.join(', '):lugar.tags) : '';
        const maps = document.getElementById('modalMaps');
        maps.href = lugar.googleMapsLink || '#';
        const gallery = document.getElementById('modalGallery');
        gallery.innerHTML = '';
        const imgs = (lugar.images && lugar.images.length) ? lugar.images : ['https://via.placeholder.com/800x600?text=Sin+Imagen'];
        imgs.forEach(src => { const i = document.createElement('img'); i.src = src; i.className = 'thumb'; gallery.appendChild(i); });
        const modalFav = document.getElementById('modalFav');
        if (modalFav) {
          modalFav.dataset.favId = lugar._id || '';
        }
        backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden', 'false');
        updateFavoriteButtons();
        const lugarId = getLugarIdentifier(lugar);
        appState.activeLugarId = lugarId;
        const reviewToPrefill = options.prefillReview || getUserReviewForLugar(lugarId);
        setupReviewForm(lugar, { prefillReview: reviewToPrefill, focusComment: options.focusComment });
        appState.reviewsByLugar[lugarId] = [];
        const loader = document.getElementById('placeReviewsLoader');
        if (loader) loader.hidden = false;
        loadLugarReviews(lugarId);
      } catch (e) { console.error(e); }
    }

    function bindModalClose() {
      const closeBtn = document.getElementById('modalCloseBtn');
      if (closeBtn) closeBtn.addEventListener('click', () => {
        const b = document.getElementById('lugarModalBackdrop');
        if (b) {
          b.style.display = 'none';
          b.setAttribute('aria-hidden','true');
        }
        appState.activeLugarId = null;
        resetReviewFormState();
      });
    }

    function bindUserReviewsRefresh() {
      const btn = document.querySelector('[data-reviews-refresh]');
      if (!btn || btn.dataset.bound === 'true') return;
      btn.dataset.bound = 'true';
      btn.addEventListener('click', () => fetchUserReviews());
    }

    async function loadLugares(options = {}) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      const filters = getActiveFilters();
      const params = new URLSearchParams();
      if (filters.q) params.set('q', filters.q);
      if (filters.categoria) params.set('categoria', filters.categoria);

      if (!options.silent) {
        grid.innerHTML = '<div class="col-span-full text-center py-12">Buscando lugares...</div>';
      }

      if (searchControl.controller) searchControl.controller.abort();
      const controller = new AbortController();
      searchControl.controller = controller;

      let list = [];
      try {
        const url = params.toString() ? `/api/lugares?${params.toString()}` : '/api/lugares';
        const res = await fetch(url, { credentials: 'include', signal: controller.signal });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para seguir explorando.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('lugares');
        const payload = await res.json();
        list = Array.isArray(payload) ? payload : (Array.isArray(payload.lugares) ? payload.lugares : []);
        if (Array.isArray(payload.favoriteIds)) applyFavoriteIds(payload.favoriteIds);
        searchControl.warned = false;
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.warn('No se pudo cargar /api/lugares', err);
        if (!searchControl.warned) {
          notify('warning', {
            title: 'Mostrando datos de ejemplo',
            message: 'No pudimos conectarnos al servidor. Intenta de nuevo más tarde.'
          });
          searchControl.warned = true;
        }
        const cached = Array.isArray(window.__lugares_cache) && window.__lugares_cache.length ? window.__lugares_cache.slice() : [];
        list = cached.length ? cached : fallbackLugares.slice();
      }

      window.__lugares_cache = list.slice();
      const filtered = filterListLocally(list, filters);
      renderLugares(filtered);
      if (!searchControl.categoriesLoaded || options.refreshCategories) {
        populateCategoryFilter(list, { force: true });
        searchControl.categoriesLoaded = true;
      }
    }

    function populateCategoryFilter(list, { force = false } = {}) {
      const sel = safeQuery('#categoryFilter');
      if (!sel || !Array.isArray(list)) return;
      if (searchControl.categoriesLoaded && !force) return;
      const cats = Array.from(new Set(list.map(l => (l.categoria && (l.categoria.nombre || l.categoria)) || (l.categoriaId && l.categoriaId.nombre) || '').filter(Boolean))).sort();
      sel.innerHTML = '<option value="">Todas las categorías</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
      if (!filtersState.bound) {
        sel.addEventListener('change', scheduleSearch);
        const search = safeQuery('#searchInput'); if (search) search.addEventListener('input', scheduleSearch);
        filtersState.bound = true;
      }
    }

    function renderLugares(list) {
      const grid = safeQuery('#lugaresGrid');
      if (!grid) return;
      appState.lugaresCache = list.slice();
      appState.lugarIndex = {};
      list.forEach(item => {
        if (item && item._id) appState.lugarIndex[String(item._id)] = item;
      });
      window.__lugares_cache = list.slice();
      if (!list || !list.length) {
        grid.innerHTML = '<div class="col-span-full text-center py-12 muted">No se encontraron lugares.</div>';
        return;
      }
      grid.innerHTML = '';
      list.forEach(l => grid.appendChild(createLugarCard(l)));
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
      updateFavoriteButtons();
    }

    function updateFavoriteButtons() {
      const ids = appState.favoriteIds;
      document.querySelectorAll('[data-fav-id]').forEach(btn => {
        const id = btn.getAttribute('data-fav-id');
        if (!id) return;
        const active = ids.has(String(id));
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        const label = btn.querySelector('.fav-label');
        if (label) label.textContent = active ? 'Guardado' : 'Favorito';
      });
    }

    function renderPlaceReviews(lugarId) {
      const list = safeQuery('#placeReviewsList');
      const empty = safeQuery('#placeReviewsEmpty');
      if (!list || !empty) return;
      const reviews = appState.reviewsByLugar[lugarId] || [];
      if (!reviews.length) {
        list.innerHTML = '';
        empty.textContent = 'Aún no hay reseñas para este lugar.';
        empty.hidden = false;
        return;
      }
      empty.hidden = true;
      list.innerHTML = reviews.map(review => {
        const rating = typeof review.rating === 'number' ? review.rating : Number(review.rating) || 0;
        return `
          <div class="modal-review-item">
            <strong>${review.autorNombre || review.usuario?.nombre || 'Visitante'}</strong>
            <span class="review-rating" style="margin-left:0.5rem;">${rating.toFixed(1)} ★</span>
            <small>${formatDate(review.createdAt || review.fecha)}</small>
            <p class="text-sm mt-2 text-[#4b372b]">${review.comment || review.comentario || ''}</p>
          </div>
        `;
      }).join('');
    }

    async function loadLugarReviews(lugarId) {
      const loader = safeQuery('#placeReviewsLoader');
      const empty = safeQuery('#placeReviewsEmpty');
      const list = safeQuery('#placeReviewsList');
      if (!lugarId || !loader || !empty || !list) return;
      loader.hidden = false;
      empty.hidden = true;
      list.innerHTML = '';
      try {
        const res = await fetch(`/api/lugares/${lugarId}/reviews`, { credentials: 'include' });
        if (!res.ok) throw new Error('place-reviews');
        const data = await res.json();
        const reviews = Array.isArray(data) ? data : (Array.isArray(data.reviews) ? data.reviews : []);
        appState.reviewsByLugar[lugarId] = reviews;
      } catch (err) {
        console.warn('No se pudieron cargar las reseñas del lugar', err);
        appState.reviewsByLugar[lugarId] = [];
        empty.textContent = 'No se pudieron cargar las reseñas. Intenta nuevamente más tarde.';
        empty.hidden = false;
      } finally {
        loader.hidden = true;
        renderPlaceReviews(lugarId);
      }
    }

    function setupReviewForm(lugar, options = {}) {
      const form = document.getElementById('reviewForm');
      const authPrompt = document.getElementById('reviewAuthPrompt');
      if (!form || !authPrompt) return;
      const lugarId = getLugarIdentifier(lugar);
      form.dataset.lugarId = lugarId;
      if (!appState.currentUser) {
        form.hidden = true;
        authPrompt.hidden = false;
        return;
      }
      authPrompt.hidden = true;
      form.hidden = false;
      if (options.prefillReview) {
        populateReviewForm(options.prefillReview, { focusComment: options.focusComment });
      } else {
        resetReviewFormState();
      }
    }

    function resetReviewFormState() {
      const form = document.getElementById('reviewForm');
      if (!form) return;
      delete form.dataset.reviewId;
      form.dataset.mode = 'create';
      form.reset();
      const ratingField = form.querySelector('[name="rating"]');
      if (ratingField) ratingField.value = '5';
      const commentField = form.querySelector('[name="comment"]');
      if (commentField) commentField.value = '';
      const submitBtn = form.querySelector('[data-review-submit]');
      if (submitBtn) submitBtn.textContent = 'Enviar reseña';
      const cancelBtn = form.querySelector('[data-review-cancel]');
      if (cancelBtn) cancelBtn.hidden = true;
    }

    function populateReviewForm(review, options = {}) {
      const form = document.getElementById('reviewForm');
      if (!form || !review) return;
      form.dataset.reviewId = review._id || '';
      form.dataset.mode = 'edit';
      const ratingField = form.querySelector('[name="rating"]');
      if (ratingField) ratingField.value = String(review.rating || 5);
      const commentField = form.querySelector('[name="comment"]');
      if (commentField) {
        commentField.value = review.comment || '';
        if (options.focusComment && typeof commentField.focus === 'function') {
          commentField.focus();
        }
      }
      const submitBtn = form.querySelector('[data-review-submit]');
      if (submitBtn) submitBtn.textContent = 'Actualizar reseña';
      const cancelBtn = form.querySelector('[data-review-cancel]');
      if (cancelBtn) cancelBtn.hidden = false;
    }

    function bindReviewForm() {
      const form = document.getElementById('reviewForm');
      if (!form || form.dataset.bound === 'true') return;
      form.dataset.bound = 'true';
      form.addEventListener('submit', handleReviewFormSubmit);
      const cancelBtn = form.querySelector('[data-review-cancel]');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          resetReviewFormState();
        });
      }
    }

    async function handleReviewFormSubmit(event) {
      event.preventDefault();
      if (!appState.currentUser) {
        notify('warning', { title: 'Inicia sesión', message: 'Debes iniciar sesión para compartir una reseña.' });
        window.location.href = '/user/login';
        return;
      }
      const form = event.target;
      const lugarId = form.dataset.lugarId;
      if (!lugarId) return;
      const rating = Number(form.rating.value || 0);
      const comment = (form.comment.value || '').trim();
      if (!rating || !comment) {
        notify('warning', { title: 'Información faltante', message: 'Selecciona una calificación y escribe tu reseña.' });
        return;
      }
      const reviewId = form.dataset.reviewId;
      const isEditing = Boolean(reviewId);
      try {
        const endpoint = isEditing ? `/api/reviews/${reviewId}` : `/api/lugares/${lugarId}/reviews`;
        const res = await fetch(endpoint, {
          method: isEditing ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ rating, comment })
        });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para enviar una reseña.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('submit-review');
        resetReviewFormState();
        notify('success', { message: isEditing ? 'Reseña actualizada' : '¡Gracias por tu reseña!' });
        await loadLugarReviews(lugarId);
        await fetchUserReviews({ silent: true });
      } catch (err) {
        console.error('No se pudo guardar la reseña', err);
        notify('error', { title: 'No guardada', message: 'No pudimos guardar tu reseña. Intenta más tarde.' });
      }
    }

    async function startReviewEditFlow(reviewId, lugarId) {
      if (!reviewId) return;
      const review = Array.isArray(appState.userReviews)
        ? appState.userReviews.find(r => String(r._id) === String(reviewId))
        : null;
      if (!review) {
        notify('info', { title: 'Reseña no encontrada', message: 'Actualiza tus reseñas e inténtalo nuevamente.' });
        return;
      }
      const targetLugarId = lugarId || review.lugarId || review.lugar;
      const lugar = await ensureLugarData(targetLugarId);
      if (!lugar) {
        notify('error', { title: 'Lugar no disponible', message: 'No pudimos cargar el lugar asociado a esta reseña.' });
        return;
      }
      openLugarModal(lugar, { prefillReview: review, focusComment: true });
      setTimeout(() => {
        const form = document.getElementById('reviewForm');
        if (form && typeof form.scrollIntoView === 'function') {
          form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 200);
    }

    async function handleReviewDelete(reviewId, lugarId) {
      if (!reviewId) return;
      const confirmed = window.confirm('¿Seguro que deseas eliminar esta reseña?');
      if (!confirmed) return;
      try {
        const res = await fetch(`/api/reviews/${reviewId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para continuar.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('delete-review');
        const data = await res.json();
        const targetLugarId = lugarId || (data && data.lugarId);
        notify('success', { message: 'Reseña eliminada.' });
        await fetchUserReviews({ silent: true });
        if (targetLugarId) {
          await loadLugarReviews(targetLugarId);
          if (String(targetLugarId) === String(appState.activeLugarId)) {
            resetReviewFormState();
          }
        }
      } catch (error) {
        console.error('No se pudo eliminar la reseña', error);
        notify('error', { title: 'No se pudo eliminar', message: 'Intenta nuevamente más tarde.' });
      }
    }

    async function toggleFavorite(lugarId, triggerEl) {
      if (!lugarId) return;
      if (!appState.currentUser) {
        window.location.href = '/user/login';
        return;
      }
      const isFav = appState.favoriteIds.has(String(lugarId));
      if (triggerEl) triggerEl.disabled = true;
      try {
        const res = await fetch(`/api/favorites/${lugarId}`, {
          method: isFav ? 'DELETE' : 'POST',
          credentials: 'include'
        });
        if (res.status === 401) {
          notify('warning', { title: 'Sesión expirada', message: 'Vuelve a iniciar sesión para seguir guardando lugares.' });
          window.location.href = '/user/login';
          return;
        }
        if (!res.ok) throw new Error('favorite');
        await fetchFavorites();
        notify('success', { message: isFav ? 'Favorito eliminado' : 'Agregado a favoritos' });
      } catch (err) {
        console.error('No se pudo actualizar favorito', err);
        notify('error', { title: 'Sin cambios', message: 'No pudimos actualizar tu favorito. Intenta más tarde.' });
      } finally {
        if (triggerEl) triggerEl.disabled = false;
        updateFavoriteButtons();
      }
    }

    document.addEventListener('click', (e) => {
      const favBtn = e.target.closest('[data-fav-id]');
      if (favBtn) {
        e.preventDefault();
        toggleFavorite(favBtn.dataset.favId, favBtn);
        return;
      }
      const detailBtn = e.target.closest('.btn-detail');
      if (detailBtn) {
        const card = detailBtn.closest('[data-lugar-id]');
        const lugar = card ? (getLugarById(card.dataset.lugarId) || card.__lugarData) : null;
        if (lugar) openLugarModal(lugar);
        return;
      }
      const editBtn = e.target.closest('[data-review-edit]');
      if (editBtn) {
        e.preventDefault();
        startReviewEditFlow(editBtn.dataset.reviewEdit, editBtn.dataset.lugarId);
        return;
      }
      const deleteBtn = e.target.closest('[data-review-delete]');
      if (deleteBtn) {
        e.preventDefault();
        handleReviewDelete(deleteBtn.dataset.reviewDelete, deleteBtn.dataset.lugarId);
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      bindModalClose();
      bindReviewForm();
      bindUserReviewsRefresh();
      initVisitorNav();
      attachLogoutHandlers();
      initImmersiveTour();
      await fetchSession();
      await loadLugares({ refreshCategories: true });
      await fetchFavorites();
      await fetchUserReviews({ silent: true });
    });
  </script>
</body>
</html>
