<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Categorías - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
  <div id="header-container"></div>
  <main class="p-6 container mx-auto">
    <div class="bg-white p-6 rounded shadow w-full">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-2xl font-bold">Categorías</h1>
          <p class="text-sm text-gray-500">Gestiona las categorías usadas en lugares. Crea, elimina y mantén ordenada la lista.</p>
        </div>
        <div class="flex items-center gap-3">
          <a href="/admin/lugares" class="text-sm text-indigo-600 hover:underline">Volver a Lugares</a>
          <input id="searchCat" placeholder="Buscar categoría..." class="px-3 py-2 border rounded text-sm" />
          <button id="btnRefreshCats" title="Recargar" class="px-3 py-2 border rounded text-sm hover:bg-gray-100">Recargar</button>
          <button id="btnAddCat" class="bg-green-600 text-white px-4 py-2 rounded shadow text-sm hover:bg-green-700">+ Agregar categoría</button>
        </div>
      </div>

      <div id="catsContainer">
        <div id="catsLoader" class="flex items-center justify-center py-8">
          <svg class="animate-spin h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
        </div>

        <div id="lista" class="grid gap-3"></div>

        <div id="catsEmpty" class="hidden text-center text-gray-500 py-8">
          No hay categorías aún. Usa "Agregar categoría" para crear la primera.
        </div>
      </div>
    </div>
  </main>

  <script src="/js/admin.js"></script>
  <script>
    async function load() {
      const loader = document.getElementById('catsLoader');
      const empty = document.getElementById('catsEmpty');
      const cont = document.getElementById('lista');
      try {
        loader.classList.remove('hidden');
        empty.classList.add('hidden');
        cont.innerHTML = '';
        const res = await fetch('/admin/categorias/api', { credentials: 'same-origin', headers: { Accept: 'application/json' } });
        const cats = await res.json();
        if (!cats || !cats.length) {
          empty.classList.remove('hidden');
          loader.classList.add('hidden');
          return;
        }
        // responsive grid: 1-col mobile, 2-cols sm, 3-cols lg
        cont.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';
        // aplicar filtro de búsqueda si hay término
        const q = (document.getElementById('searchCat')?.value || '').trim().toLowerCase();
        const filtered = q ? cats.filter(x => x.nombre.toLowerCase().includes(q)) : cats;
        filtered.forEach(c => {
          const card = document.createElement('div');
          card.className = 'border p-3 rounded flex flex-col justify-between h-28';
          card.innerHTML = `<div class="font-medium">${c.nombre}</div>
            <div class="mt-3 flex items-center justify-between">
              <small class="text-xs text-gray-500">id: ${c._id.slice(-6)}</small>
              <div class="flex gap-2">
                <button data-id="${c._id}" class="btn-edit-cat text-indigo-600 text-sm">Editar</button>
                <button data-id="${c._id}" class="btn-delete-cat text-red-600 text-sm">Eliminar</button>
              </div>
            </div>`;
          cont.appendChild(card);
        });
        loader.classList.add('hidden');
      } catch (e) {
        loader.classList.add('hidden');
        console.warn('Error cargando categorias', e);
        if (window.swalToast) window.swalToast('error', 'No se pudieron cargar las categorías');
      }
    }

  document.getElementById('btnAddCat').addEventListener('click', async (e) => {
      // abrir modal SweetAlert para input
      if (!window.ensureSwal) {
        // fallback simple prompt
        const nombre = prompt('Nombre de la nueva categoría');
        if (!nombre) return;
        await fetch('/admin/categorias/api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre }), credentials: 'same-origin' });
        load();
        return;
      }
      const Swal = await ensureSwal();
      const { value: nombre } = await Swal.fire({
        position: 'center',
        title: 'Nueva categoría',
        input: 'text',
        inputLabel: 'Nombre de la categoría',
        inputPlaceholder: 'Ej. Gastronomía',
        showCancelButton: true,
        confirmButtonText: 'Crear',
        cancelButtonText: 'Cancelar',
        inputValidator: (val) => (!val || !val.trim()) ? 'El nombre no puede estar vacío' : null
      });
      if (!nombre) return;
      try {
        const res = await fetch('/admin/categorias/api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre: nombre.trim() }), credentials: 'same-origin' });
        if (res.ok) {
          if (window.swalToast) window.swalToast('success', 'Categoría creada');
          load();
        } else {
          const txt = await res.text();
          if (window.swalToast) window.swalToast('error', txt || 'Error creando categoría');
        }
      } catch (err) {
        if (window.swalToast) window.swalToast('error', 'Error de conexión');
      }
    });

  document.getElementById('lista').addEventListener('click', async (e) => {
      if (e.target && e.target.dataset && e.target.dataset.id) {
        const id = e.target.dataset.id;
        // Editar
        if (e.target.classList.contains('btn-edit-cat')) {
          try {
            const Swal = await ensureSwal();
            // obtener nombre actual (podríamos pedir al servidor, pero usamos texto del card)
            const card = e.target.closest('div.border');
            const current = card ? card.querySelector('.font-medium')?.textContent.trim() : '';
            const { value: nombre } = await Swal.fire({
              position: 'center',
              title: 'Editar categoría',
              input: 'text',
              inputLabel: 'Nombre de la categoría',
              inputValue: current || '',
              showCancelButton: true,
              confirmButtonText: 'Guardar',
              cancelButtonText: 'Cancelar',
              inputValidator: (val) => (!val || !val.trim()) ? 'El nombre no puede estar vacío' : null
            });
            if (!nombre) return;
            const res = await fetch('/admin/categorias/api/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre: nombre.trim() }), credentials: 'same-origin' });
            if (res.ok) {
              if (window.swalToast) window.swalToast('success', 'Categoría actualizada');
              document.dispatchEvent(new CustomEvent('categorias:updated'));
            } else {
              const txt = await res.text();
              if (window.swalToast) window.swalToast('error', txt || 'Error actualizando');
            }
          } catch (err) { if (window.swalToast) window.swalToast('error', 'Error de conexión'); }
          return;
        }
        // Eliminar
        if (e.target.classList.contains('btn-delete-cat')) {
          try {
            let confirmRes = true;
            if (window.swalConfirm) {
              const r = await window.swalConfirm({ title: 'Eliminar categoría', text: '¿Deseas eliminar esta categoría?', icon: 'warning' });
              confirmRes = !!r.isConfirmed;
            } else {
              confirmRes = confirm('Eliminar categoría?');
            }
            if (!confirmRes) return;
            const res = await fetch('/admin/categorias/api/' + id, { method: 'DELETE', credentials: 'same-origin' });
            if (res.ok) {
              if (window.swalToast) window.swalToast('success', 'Categoría eliminada');
              load();
            } else {
              const txt = await res.text();
              if (window.swalToast) window.swalToast('error', txt || 'Error eliminando');
            }
          } catch (err) { if (window.swalToast) window.swalToast('error', 'Error de conexión'); }
        }
      }
  });

  // Reload listener and external update listener
  document.getElementById('btnRefreshCats')?.addEventListener('click', () => load());
  // filtro en tiempo real
  document.getElementById('searchCat')?.addEventListener('input', () => load());
  document.addEventListener('categorias:updated', () => load());

  // Inicial load
  load();
  </script>
</body>
</html>
