<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Categorías - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/admin-core.css" />
</head>
<body class="admin-theme min-h-screen font-sans text-gray-900">
  <div class="min-h-screen flex flex-col">
    <div id="header-container"></div>
    <main class="flex-1">
      <div class="admin-shell">
        <section class="admin-hero admin-hero--compact">
          <span class="admin-eyebrow">Colección viva</span>
          <h1>Categorías curatoriales</h1>
          <p>Organiza los ejes temáticos que estructuran la experiencia del directorio. Mantén etiquetas consistentes para lograr búsquedas más precisas.</p>
          <div class="admin-pill-row">
            <span class="admin-pill">Lista verificada</span>
            <span class="admin-pill">Cambios auditados</span>
          </div>
        </section>

        <section class="admin-panel">
          <div class="admin-toolbar w-full">
            <div>
              <p class="admin-eyebrow">Inventario</p>
              <h2>Gestión de categorías</h2>
              <p class="admin-muted text-sm">Crea, edita o elimina en segundos. Todos los cambios impactan inmediatamente a los formularios de lugares.</p>
            </div>
            <div class="admin-toolbar__actions w-full md:w-auto">
              <a href="/admin/lugares" class="admin-link text-sm">Ver lugares</a>
              <input id="searchCat" placeholder="Buscar categoría..." class="admin-input admin-toolbar__input" />
              <button id="btnRefreshCats" title="Recargar" class="admin-btn admin-btn--ghost text-xs">Recargar</button>
              <button id="btnAddCat" class="admin-btn admin-btn--primary text-xs">+ Agregar categoría</button>
            </div>
          </div>

          <div id="catsContainer" class="space-y-4">
            <div id="catsLoader" class="admin-empty flex items-center justify-center gap-3">
              <svg class="animate-spin h-6 w-6 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
              </svg>
              Cargando categorías
            </div>

            <div id="lista" class="admin-card-list"></div>

            <div id="catsEmpty" class="admin-empty hidden">
              No hay categorías aún. Usa «Agregar categoría» para crear la primera.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="/js/admin.js"></script>
  <script>
    async function load() {
      const loader = document.getElementById('catsLoader');
      const empty = document.getElementById('catsEmpty');
      const cont = document.getElementById('lista');
      try {
        loader.classList.remove('hidden');
        empty.classList.add('hidden');
        cont.innerHTML = '';
        const res = await fetch('/admin/categorias/api', { credentials: 'same-origin', headers: { Accept: 'application/json' } });
        const cats = await res.json();
        if (!cats || !cats.length) {
          empty.classList.remove('hidden');
          loader.classList.add('hidden');
          return;
        }
        cont.className = 'admin-card-list';
        // aplicar filtro de búsqueda si hay término
        const q = (document.getElementById('searchCat')?.value || '').trim().toLowerCase();
        const filtered = q ? cats.filter(x => x.nombre.toLowerCase().includes(q)) : cats;
        filtered.forEach(c => {
          const card = document.createElement('div');
          card.className = 'admin-card-list__item';
          card.innerHTML = `
            <div>
              <p class="admin-eyebrow text-xs">Categoría</p>
              <h3 class="text-lg font-semibold" data-cat-name>${c.nombre}</h3>
            </div>
            <div class="admin-divider"></div>
            <div class="admin-list-actions">
              <small class="text-xs admin-muted">ID · ${c._id.slice(-6)}</small>
              <div class="flex gap-3 text-sm">
                <button data-id="${c._id}" class="btn-edit-cat admin-link">Editar</button>
                <button data-id="${c._id}" class="btn-delete-cat text-red-600 font-semibold">Eliminar</button>
              </div>
            </div>`;
          cont.appendChild(card);
        });
        loader.classList.add('hidden');
      } catch (e) {
        loader.classList.add('hidden');
        console.warn('Error cargando categorias', e);
        if (window.swalToast) window.swalToast('error', 'No se pudieron cargar las categorías');
      }
    }

  document.getElementById('btnAddCat').addEventListener('click', async (e) => {
      // abrir modal SweetAlert para input
      if (!window.ensureSwal) {
        // fallback simple prompt
        const nombre = prompt('Nombre de la nueva categoría');
        if (!nombre) return;
        await fetch('/admin/categorias/api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre }), credentials: 'same-origin' });
        load();
        return;
      }
      const Swal = await ensureSwal();
      const { value: nombre } = await Swal.fire({
        position: 'center',
        title: 'Nueva categoría',
        input: 'text',
        inputLabel: 'Nombre de la categoría',
        inputPlaceholder: 'Ej. Gastronomía',
        showCancelButton: true,
        confirmButtonText: 'Crear',
        cancelButtonText: 'Cancelar',
        inputValidator: (val) => (!val || !val.trim()) ? 'El nombre no puede estar vacío' : null
      });
      if (!nombre) return;
      try {
        const res = await fetch('/admin/categorias/api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre: nombre.trim() }), credentials: 'same-origin' });
        if (res.ok) {
          if (window.swalToast) window.swalToast('success', 'Categoría creada');
          load();
        } else {
          const txt = await res.text();
          if (window.swalToast) window.swalToast('error', txt || 'Error creando categoría');
        }
      } catch (err) {
        if (window.swalToast) window.swalToast('error', 'Error de conexión');
      }
    });

  document.getElementById('lista').addEventListener('click', async (e) => {
      if (e.target && e.target.dataset && e.target.dataset.id) {
        const id = e.target.dataset.id;
        // Editar
        if (e.target.classList.contains('btn-edit-cat')) {
          try {
            const Swal = await ensureSwal();
            // obtener nombre actual (podríamos pedir al servidor, pero usamos texto del card)
            const card = e.target.closest('.admin-card-list__item');
            const current = card ? card.querySelector('[data-cat-name]')?.textContent.trim() : '';
            const { value: nombre } = await Swal.fire({
              position: 'center',
              title: 'Editar categoría',
              input: 'text',
              inputLabel: 'Nombre de la categoría',
              inputValue: current || '',
              showCancelButton: true,
              confirmButtonText: 'Guardar',
              cancelButtonText: 'Cancelar',
              inputValidator: (val) => (!val || !val.trim()) ? 'El nombre no puede estar vacío' : null
            });
            if (!nombre) return;
            const res = await fetch('/admin/categorias/api/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre: nombre.trim() }), credentials: 'same-origin' });
            if (res.ok) {
              if (window.swalToast) window.swalToast('success', 'Categoría actualizada');
              document.dispatchEvent(new CustomEvent('categorias:updated'));
            } else {
              const txt = await res.text();
              if (window.swalToast) window.swalToast('error', txt || 'Error actualizando');
            }
          } catch (err) { if (window.swalToast) window.swalToast('error', 'Error de conexión'); }
          return;
        }
        // Eliminar
        if (e.target.classList.contains('btn-delete-cat')) {
          try {
            let confirmRes = true;
            if (window.swalConfirm) {
              const r = await window.swalConfirm({ title: 'Eliminar categoría', text: '¿Deseas eliminar esta categoría?', icon: 'warning' });
              confirmRes = !!r.isConfirmed;
            } else {
              confirmRes = confirm('Eliminar categoría?');
            }
            if (!confirmRes) return;
            const res = await fetch('/admin/categorias/api/' + id, { method: 'DELETE', credentials: 'same-origin' });
            if (res.ok) {
              if (window.swalToast) window.swalToast('success', 'Categoría eliminada');
              load();
            } else {
              const txt = await res.text();
              if (window.swalToast) window.swalToast('error', txt || 'Error eliminando');
            }
          } catch (err) { if (window.swalToast) window.swalToast('error', 'Error de conexión'); }
        }
      }
  });

  // Reload listener and external update listener
  document.getElementById('btnRefreshCats')?.addEventListener('click', () => load());
  // filtro en tiempo real
  document.getElementById('searchCat')?.addEventListener('input', () => load());
  document.addEventListener('categorias:updated', () => load());

  // Inicial load
  load();
  </script>
</body>
</html>
